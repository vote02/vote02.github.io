<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大众投票平台</title>
    <!-- Pi Network SDK -->
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
/* 通用样式 */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #8B5CF6 0%, #A855F7 50%, #C084FC 100%);
    min-height: 100vh;
    color: #333;
    line-height: 1.6;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* 头部样式 */
.header {
    background: rgba(139, 92, 246, 0.35);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.5);
}

.header h1 {
    text-align: center;
    color: white;
    margin-bottom: 10px;
    font-size: 2.5em;
    font-weight: 700;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

.header .subtitle {
    text-align: center;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 20px;
    font-size: 1.1em;
    font-weight: 400;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.user-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

.user-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #8B5CF6;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.2em;
}

.user-details h3 {
    color: white;
    margin-bottom: 5px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.user-details p {
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.9em;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.points-info {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #A855F7;
    padding: 10px 20px;
    border-radius: 25px;
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.points-info:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

.points-icon {
    font-size: 1.2em;
}

.user-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

/* 卡片样式 */
.card {
    background: rgba(139, 92, 246, 0.35);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.5);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: #8B5CF6;
}

.card h2 {
    color: white;
    margin-bottom: 20px;
    font-size: 1.8em;
    display: flex;
    align-items: center;
    justify-content: space-between;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

.card-toggle {
    cursor: pointer;
    font-size: 1.2em;
    color: white;
    transition: transform 0.3s ease;
    user-select: none;
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.card.expanded .card-toggle {
    transform: translateY(-50%) rotate(180deg);
}

.card-content {
    transition: all 0.3s ease;
    overflow: hidden;
}

.card-content.collapsed {
    max-height: 0;
    opacity: 0;
    padding: 0;
    margin: 0;
}

/* 表单样式 */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: white;
    font-weight: 600;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 16px;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.8);
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: #8B5CF6;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    background: rgba(255, 255, 255, 1);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

/* 按钮样式 */
.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-width: 120px;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

.btn:active {
    transform: translateY(0);
}

.btn-primary {
    background: #8B5CF6;
    color: white;
}

.btn-secondary {
    background: linear-gradient(135deg, #f093fb, #f5576c);
    color: white;
}

.btn-success {
    background: linear-gradient(135deg, #4facfe, #00f2fe);
    color: white;
}

.btn-danger {
    background: linear-gradient(135deg, #fa709a, #fee140);
    color: white;
}

.btn-outline {
    background: rgba(139, 92, 246, 0.1);
    border: 2px solid #8B5CF6;
    color: white;
    font-weight: 600;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
}

.btn-outline:hover {
    background: #8B5CF6;
    color: white;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn:disabled:hover {
    transform: none;
    box-shadow: none;
}

/* 模态框样式 */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    animation: fadeIn 0.3s ease;
}

.modal-content {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    margin: 5% auto;
    padding: 30px;
    border-radius: 20px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.2);
    animation: slideIn 0.3s ease;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s ease;
}

.close:hover {
    color: #8B5CF6;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* 项目卡片样式 */
.project-card {
    background: rgba(139, 92, 246, 0.35);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.5);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.project-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
}

.project-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: #8B5CF6;
}

.project-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
    flex-wrap: wrap;
    gap: 10px;
}

.project-title {
    font-size: 1.3em;
    font-weight: 700;
    color: #4a5568;
    margin: 0;
    flex: 1;
    min-width: 200px;
}

.project-status {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-active {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
}

.status-ended {
    background: linear-gradient(135deg, #ed8936, #dd6b20);
    color: white;
}

.status-published {
    background: #8B5CF6;
    color: white;
}

.project-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.info-item {
    text-align: center;
    padding: 10px;
    background: rgba(139, 92, 246, 0.1);
    border-radius: 12px;
}

.info-label {
    font-size: 0.8em;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.info-value {
    font-size: 1.1em;
    font-weight: 700;
    color: white;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.project-description {
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 15px;
    line-height: 1.6;
    padding: 15px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 12px;
    border-left: 4px solid #8B5CF6;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.project-options {
    margin-bottom: 20px;
}

.project-options h4 {
    color: white;
    margin-bottom: 10px;
    font-size: 1.1em;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.option-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    margin-bottom: 8px;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 10px;
    border: 1px solid rgba(139, 92, 246, 0.2);
    transition: all 0.3s ease;
}

.option-item:hover {
    background: rgba(139, 92, 246, 0.1);
    border-color: #8B5CF6;
}

.option-text {
    font-weight: 600;
    color: #4a5568;
}

.option-stats {
    display: flex;
    gap: 15px;
    font-size: 0.9em;
    color: #718096;
}

.project-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
}

.project-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid rgba(139, 92, 246, 0.2);
    font-size: 0.9em;
    color: rgba(255, 255, 255, 0.8);
    flex-wrap: wrap;
    gap: 10px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.project-creator {
    font-weight: 600;
}

.project-deadline {
    color: #e53e3e;
    font-weight: 600;
}

/* 投票信息样式 */
.vote-info {
    background: linear-gradient(135deg, #e6fffa, #b2f5ea);
    border: 2px solid #4fd1c7;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
}

.vote-info h4 {
    color: #234e52;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.vote-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    font-size: 0.9em;
}

.vote-detail {
    text-align: center;
    padding: 8px;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 8px;
}

.vote-detail-label {
    color: #4a5568;
    font-size: 0.8em;
    margin-bottom: 3px;
}

.vote-detail-value {
    font-weight: 700;
    color: #234e52;
}

/* 统计徽章样式 */
.stats-badges {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    justify-content: center;
}

.stat-badge {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 12px 20px;
    border-radius: 25px;
    text-align: center;
    min-width: 120px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
}

.stat-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.stat-number {
    font-size: 1.5em;
    font-weight: 700;
    display: block;
}

.stat-label {
    font-size: 0.8em;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* 空状态样式 */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: rgba(255, 255, 255, 0.8);
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.empty-state-icon {
    font-size: 3em;
    margin-bottom: 15px;
    opacity: 0.7;
}

.empty-state h3 {
    margin-bottom: 10px;
    color: white;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.empty-state p {
    font-size: 0.9em;
    line-height: 1.6;
}

/* 加载动画 */
.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e2e8f0;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* 自定义警告框样式 */
.custom-alert {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.custom-alert-content {
    background: white;
    padding: 30px;
    border-radius: 20px;
    text-align: center;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    transform: scale(0.8);
    transition: transform 0.3s ease;
}

.custom-alert.show {
    opacity: 1;
}

.custom-alert.show .custom-alert-content {
    transform: scale(1);
}

.custom-alert-icon {
    font-size: 3em;
    margin-bottom: 15px;
}

.custom-alert-message {
    font-size: 1.1em;
    color: #4a5568;
    margin-bottom: 20px;
    line-height: 1.6;
}

.custom-alert-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
}

/* 自定义确认框样式 */
.custom-confirm {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.custom-confirm-content {
    background: white;
    padding: 30px;
    border-radius: 20px;
    text-align: center;
    max-width: 450px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    transform: scale(0.8);
    transition: transform 0.3s ease;
}

.custom-confirm.show {
    opacity: 1;
}

.custom-confirm.show .custom-confirm-content {
    transform: scale(1);
}

/* 自定义输入框样式 */
.custom-prompt {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.custom-prompt-content {
    background: white;
    padding: 30px;
    border-radius: 20px;
    text-align: center;
    max-width: 450px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    transform: scale(0.8);
    transition: transform 0.3s ease;
}

.custom-prompt.show {
    opacity: 1;
}

.custom-prompt.show .custom-prompt-content {
    transform: scale(1);
}

.custom-prompt-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 16px;
    margin: 15px 0;
    transition: border-color 0.3s ease;
}

.custom-prompt-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* 积分明细模态框样式 */
.points-detail-modal {
    z-index: 9999;
}

.points-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 15px;
    color: white;
}

.summary-item {
    text-align: center;
}

.summary-label {
    font-size: 0.8em;
    opacity: 0.9;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.summary-value {
    font-size: 1.3em;
    font-weight: 700;
}

.points-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e2e8f0;
}

.points-detail-list {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 10px;
}

.detail-item {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 15px;
    padding: 15px;
    margin-bottom: 10px;
    background: rgba(102, 126, 234, 0.05);
    border-radius: 12px;
    border-left: 4px solid #667eea;
    transition: all 0.3s ease;
}

.detail-item:hover {
    background: rgba(102, 126, 234, 0.1);
    transform: translateX(5px);
}

.detail-time {
    font-size: 0.8em;
    color: #718096;
    white-space: nowrap;
}

.detail-type {
    font-weight: 600;
    color: #4a5568;
}

.detail-change {
    font-weight: 700;
    text-align: right;
    white-space: nowrap;
}

.detail-change.positive {
    color: #48bb78;
}

.detail-change.negative {
    color: #e53e3e;
}

.detail-description {
    grid-column: 1 / -1;
    font-size: 0.9em;
    color: #718096;
    margin-top: 5px;
    padding-top: 10px;
    border-top: 1px solid rgba(102, 126, 234, 0.1);
}

.empty-detail {
    text-align: center;
    padding: 40px 20px;
    color: #718096;
    font-style: italic;
}

/* 项目卡片展开/折叠状态 */
.project-card.expanded {
    background: rgba(255, 255, 255, 0.98);
}

.project-card.collapsed .project-description,
.project-card.collapsed .project-options,
.project-card.collapsed .vote-info {
    display: none;
}

/* 移动端响应式设计 */
@media (max-width: 768px) {
    .container {
        padding: 10px;
    }
    
    .header {
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .header h1 {
        font-size: 2em;
        margin-bottom: 15px;
    }
    
    .user-section {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    .user-info {
        justify-content: center;
    }
    
    .user-actions {
        justify-content: center;
    }
    
    .points-info {
        justify-content: center;
        padding: 12px 20px;
    }
    
    .card {
        padding: 20px;
        margin-bottom: 15px;
    }
    
    .card h2 {
        font-size: 1.5em;
        margin-bottom: 15px;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
        font-size: 16px; /* 防止iOS缩放 */
    }
    
    .btn {
        padding: 14px 20px;
        font-size: 16px;
        min-width: 100px;
    }
    
    .modal-content {
        margin: 10% auto;
        padding: 20px;
        width: 95%;
        max-height: 85vh;
    }
    
    .project-card {
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .project-header {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    
    .project-title {
        font-size: 1.2em;
        min-width: auto;
    }
    
    .project-info {
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 10px;
    }
    
    .info-item {
        padding: 8px;
    }
    
    .project-actions {
        flex-direction: column;
    }
    
    .project-meta {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
        text-align: center;
    }
    
    .stats-badges {
        flex-direction: column;
        align-items: center;
    }
    
    .stat-badge {
        min-width: 200px;
    }
    
    .vote-details {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    }
    
    .option-item {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
        text-align: center;
    }
    
    .option-stats {
        justify-content: center;
    }
    
    .custom-alert-content,
    .custom-confirm-content,
    .custom-prompt-content {
        width: 95%;
        padding: 25px;
    }
    
    .custom-alert-buttons {
        flex-direction: column;
    }
    
    .points-summary {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 10px;
        padding: 15px;
    }
    
    .detail-item {
        grid-template-columns: 1fr;
        gap: 8px;
        text-align: center;
    }
    
    .detail-change {
        text-align: center;
    }
    
    .detail-description {
        grid-column: 1;
        text-align: left;
    }
    
    .points-detail-list {
        max-height: 300px;
    }
}

@media (max-width: 480px) {
    .container {
        padding: 5px;
    }
    
    .header {
        padding: 10px;
    }
    
    .header h1 {
        font-size: 1.8em;
    }
    
    .card {
        padding: 15px;
    }
    
    .modal-content {
        margin: 5% auto;
        padding: 15px;
        width: 98%;
        max-height: 90vh;
    }
    
    .project-card {
        padding: 12px;
    }
    
    .btn {
        padding: 12px 16px;
        font-size: 14px;
        min-width: 80px;
    }
    
    .points-info {
        padding: 10px 16px;
        font-size: 0.9em;
    }
    
    .stat-badge {
        min-width: 150px;
        padding: 10px 16px;
    }
}

/* 按钮样式补充 */
.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
}

.btn-secondary {
    background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
    color: white;
    border: none;
}

.btn-secondary:hover {
    background: linear-gradient(135deg, #d69e2e 0%, #c05621 100%);
}

.btn-danger {
    background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
    color: white;
    border: none;
}

.btn-danger:hover {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
}

.btn-success {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
    border: none;
}

.btn-success:hover {
    background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
}

/* 已发布结果样式 */
.published-result {
    background: linear-gradient(135deg, #e6fffa, #b2f5ea);
    border: 2px solid #4fd1c7;
    border-radius: 12px;
    padding: 20px;
    margin-top: 15px;
}

.published-result h4 {
    color: #234e52;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.result-option {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    margin-bottom: 10px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 10px;
    border-left: 4px solid #4fd1c7;
}

.result-option.winner {
    background: linear-gradient(135deg, #fef5e7, #fed7aa);
    border-left-color: #f6ad55;
    font-weight: 700;
}

.result-stats {
    display: flex;
    gap: 20px;
    font-size: 0.9em;
    color: white;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

/* 发布表单样式 */
.publish-form {
    background: rgba(255, 255, 255, 0.95);
    padding: 25px;
    border-radius: 15px;
    border: 2px solid #e2e8f0;
}

.publish-warning {
    background: linear-gradient(135deg, #fed7d7, #feb2b2);
    border: 2px solid #fc8181;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    color: #742a2a;
}

.publish-warning h4 {
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.option-selection {
    margin-bottom: 20px;
}

.option-selection h4 {
    color: white;
    margin-bottom: 15px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.option-radio {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    margin-bottom: 10px;
    background: rgba(102, 126, 234, 0.05);
    border-radius: 10px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.3s ease;
}

.option-radio:hover {
    background: rgba(102, 126, 234, 0.1);
    border-color: #667eea;
}

.option-radio input[type="radio"] {
    margin-right: 12px;
    transform: scale(1.2);
}

.option-radio.selected {
    background: rgba(102, 126, 234, 0.15);
    border-color: #667eea;
    font-weight: 600;
}

/* 子卡片样式 */
.sub-section {
    margin-top: 20px;
}

.sub-card {
    background: rgba(255, 255, 255, 0.8);
    border-radius: 12px;
    margin-bottom: 15px;
    border: 1px solid rgba(102, 126, 234, 0.2);
    overflow: hidden;
    transition: all 0.3s ease;
}

.sub-card:hover {
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
}

.sub-card-header {
    padding: 15px 20px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
}

.sub-card-title {
    font-size: 1.1em;
    font-weight: 600;
    margin: 0;
}

.sub-card-toggle {
    font-size: 1.2em;
    transition: transform 0.3s ease;
    user-select: none;
}

.sub-card.expanded .sub-card-toggle {
    transform: rotate(180deg);
}

.sub-card-content {
    transition: all 0.3s ease;
    overflow: hidden;
}

.sub-card-content.collapsed {
    max-height: 0;
    opacity: 0;
    padding: 0;
}

.sub-card-content:not(.collapsed) {
    padding: 20px;
}

/* 我的项目特殊颜色 */
.sub-card.created-projects .sub-card-header {
    background: linear-gradient(135deg, #48bb78, #38a169);
}

.sub-card.participated-projects .sub-card-header {
    background: linear-gradient(135deg, #ed8936, #dd6b20);
}

/* 模态框特殊样式 */
.modal.points-detail-modal {
    z-index: 99999;
}

.modal.test-login-modal {
    z-index: 10001;
}

.modal.custom-alert {
    z-index: 10002;
}

.modal.custom-confirm {
    z-index: 10003;
}

.modal.custom-prompt {
    z-index: 10004;
}

/* 模态框动画增强 */
.modal.show {
    animation: modalFadeIn 0.3s ease;
}

.modal.show .modal-content {
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        backdrop-filter: blur(0px);
    }
    to {
        opacity: 1;
        backdrop-filter: blur(5px);
    }
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-30px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* 关闭按钮增强 */
.modal .close {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 24px;
    font-weight: bold;
    color: #aaa;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.05);
}

.modal .close:hover {
    color: #667eea;
    background: rgba(102, 126, 234, 0.1);
    transform: scale(1.1);
}

/* 模态框内选项样式 */
.modal-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
}

.modal-option {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: rgba(102, 126, 234, 0.05);
    border-radius: 10px;
    border: 1px solid rgba(102, 126, 234, 0.2);
    transition: all 0.3s ease;
}

.modal-option:hover {
    background: rgba(102, 126, 234, 0.1);
    border-color: #667eea;
}

.option-progress {
    width: 100%;
    height: 8px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 8px;
}

.option-progress-bar {
    height: 100%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 4px;
    transition: width 0.5s ease;
}

/* 结果显示样式 */
.result-display {
    background: linear-gradient(135deg, #f7fafc, #edf2f7);
    border-radius: 15px;
    padding: 20px;
    margin-top: 20px;
    border: 2px solid #e2e8f0;
}

.result-display h3 {
    color: #4a5568;
    margin-bottom: 20px;
    text-align: center;
    font-size: 1.3em;
}

.result-option {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    margin-bottom: 12px;
    background: white;
    border-radius: 10px;
    border-left: 4px solid #e2e8f0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
}

.result-option:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.result-option.winner {
    background: linear-gradient(135deg, #fef5e7, #fed7aa);
    border-left-color: #f6ad55;
    font-weight: 700;
    transform: scale(1.02);
}

.result-option.winner:hover {
    transform: scale(1.02) translateX(5px);
}

/* 测试登录模态框样式 */
.test-login-modal .modal-content {
    max-width: 500px;
}

.user-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
    max-height: 300px;
    overflow-y: auto;
}

.user-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background: rgba(102, 126, 234, 0.05);
    border-radius: 10px;
    border: 1px solid rgba(102, 126, 234, 0.2);
    transition: all 0.3s ease;
}

.user-item:hover {
    background: rgba(102, 126, 234, 0.1);
    border-color: #667eea;
}

.user-item.current {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    font-weight: 600;
}

.user-info-test {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}

.user-name {
    font-weight: 600;
    margin-bottom: 2px;
}

.user-points {
    font-size: 0.9em;
    opacity: 0.8;
}

.test-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
}

/* 规则内容样式 */
.rules-content {
    padding: 0;
}

.rule-section {
    margin-bottom: 25px;
    padding: 20px;
    background: rgba(102, 126, 234, 0.05);
    border-radius: 12px;
    border-left: 4px solid #667eea;
}

.rule-section h3 {
    color: white;
    margin-bottom: 15px;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    gap: 8px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.rule-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.rule-list li {
    padding: 8px 0;
    padding-left: 20px;
    position: relative;
    line-height: 1.6;
    color: white;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.rule-list li::before {
    content: '•';
    color: #667eea;
    font-weight: bold;
    position: absolute;
    left: 0;
    top: 8px;
}

/* 统计徽章样式 */
.stats-badge {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 600;
    margin-left: 10px;
}

/* 项目统计样式 */
.project-stats {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-bottom: 20px;
    padding: 20px;
    background: rgba(102, 126, 234, 0.05);
    border-radius: 12px;
}

.stat-item {
    text-align: center;
}

.stat-number {
    display: block;
    font-size: 2em;
    font-weight: bold;
    color: #667eea;
    line-height: 1;
}

.stat-label {
    display: block;
    font-size: 0.9em;
    color: rgba(255, 255, 255, 0.8);
    margin-top: 5px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

/* 选项显示样式 */
.options-display {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.option-item {
    flex: 1;
    padding: 12px;
    background: rgba(102, 126, 234, 0.1);
    border: 2px solid #667eea;
    border-radius: 8px;
    text-align: center;
    font-weight: 600;
    color: #667eea;
}

/* 卡片容器样式 */
.card-container {
    margin-bottom: 20px;
}

/* 项目网格样式 */
.projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

/* 充值/提现表单样式 */
.recharge-form,
.withdraw-form {
    padding: 0;
}

.balance-display {
    background: rgba(102, 126, 234, 0.1);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    text-align: center;
}

.exchange-rate {
    text-align: center;
    margin-bottom: 20px;
    color: white;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.receive-address,
.transfer-info,
.withdraw-input {
    margin-bottom: 20px;
}

.address-container {
    display: flex;
    gap: 10px;
    margin: 10px 0;
}

.address-container input {
    flex: 1;
}

.btn-copy {
    background: #667eea;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s ease;
}

.btn-copy:hover {
    background: #5a67d8;
}

.address-note {
    font-size: 0.9em;
    color: rgba(255, 255, 255, 0.8);
    margin-top: 5px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.transfer-input,
.withdraw-input {
    margin-bottom: 15px;
}

.transfer-amount-inline .inline-input-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.convert-info {
    font-size: 0.9em;
    color: #667eea;
    font-weight: 600;
}

.recharge-notice,
.withdraw-notice {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid #ffc107;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.notice-text {
    margin-bottom: 10px;
    color: #856404;
    font-weight: 600;
}

.notice-list {
    margin: 0;
    padding-left: 20px;
    color: #856404;
}

.notice-list li {
    margin-bottom: 5px;
}

.frozen-notice {
    font-size: 0.9em;
    color: #e53e3e;
    margin-top: 5px;
}

/* 响应式设计增强 */
@media (max-width: 768px) {
    .sub-card-header {
        padding: 12px 15px;
    }
    
    .sub-card-content:not(.collapsed) {
        padding: 15px;
    }
    
    .result-display {
        padding: 15px;
    }
    
    .modal-option {
        padding: 12px;
    }
    
    .user-item {
        padding: 10px 12px;
    }
    
    .test-actions {
        flex-direction: column;
    }
    
    .project-stats {
        gap: 20px;
    }
    
    .stat-number {
        font-size: 1.5em;
    }
    
    .projects-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .options-display {
        flex-direction: column;
    }
    
    .address-container {
        flex-direction: column;
    }
    
    .transfer-amount-inline .inline-input-group {
        flex-direction: column;
        align-items: stretch;
    }
}

@media (max-width: 480px) {
    .sub-card-header {
        padding: 10px 12px;
    }
    
    .sub-card-content:not(.collapsed) {
        padding: 12px;
    }
    
    .result-display {
        padding: 12px;
    }
    
    .result-option {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
        text-align: center;
    }
    
    .result-stats {
        justify-content: center;
    }
    
    .rule-section {
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .project-stats {
        flex-direction: column;
        gap: 15px;
    }
}
    </style>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script>
        window.Pi = window.Pi || {};
    </script>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1>🗳️ 大众投票平台</h1>
            <p class="subtitle">参与投票获取奖励</p>
            <div class="user-section">
                <div class="user-info" id="userInfo" style="display: none;">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-details">
                        <h3 id="userName">未登录</h3>
                        <p id="userStats">积分: 0 | 投票: 0次</p>
                    </div>
                    <div class="points-info" id="pointsBalance" title="点击查看积分明细">
                        <span class="points-icon">💰</span>
                        <span id="pointsValue">0</span>
                    </div>
                </div>
                <div class="user-actions">
                    <button class="btn btn-success" id="rechargeBtn">充值</button>
                    <button class="btn btn-primary" id="loginBtn">登录</button>
                    <button class="btn btn-secondary" id="logoutBtn" style="display: none;">退出</button>
                    <button class="btn btn-outline" id="withdrawBtn">提现</button>
                </div>
         </div>
     </div>

    <!-- 自定义警告框 -->
    <div id="customAlert" class="custom-alert">
        <div class="custom-alert-content">
            <div class="custom-alert-icon">⚠️</div>
            <div class="custom-alert-message" id="customAlertMessage">这是一个警告消息</div>
            <div class="custom-alert-buttons">
                <button class="btn btn-primary" id="customAlertOk">确定</button>
            </div>
        </div>
    </div>

    <!-- 自定义确认框 -->
    <div id="customConfirm" class="custom-confirm">
        <div class="custom-confirm-content">
            <div class="custom-alert-icon">❓</div>
            <div class="custom-alert-message" id="customConfirmMessage">确定要执行此操作吗？</div>
            <div class="custom-alert-buttons">
                <button class="btn btn-primary" id="customConfirmOk">确定</button>
                <button class="btn btn-outline" id="customConfirmCancel">取消</button>
            </div>
        </div>
    </div>

    <!-- 自定义输入框 -->
    <div id="customPrompt" class="custom-prompt">
        <div class="custom-prompt-content">
            <div class="custom-alert-icon">📝</div>
            <div class="custom-alert-message" id="customPromptMessage">请输入内容:</div>
            <input type="text" class="custom-prompt-input" id="customPromptInput" placeholder="请输入...">
            <div class="custom-alert-buttons">
                <button class="btn btn-primary" id="customPromptOk">确定</button>
                <button class="btn btn-outline" id="customPromptCancel">取消</button>
            </div>
        </div>
    </div>

    <!-- 积分明细模态框 -->
    <div id="pointsDetailModal" class="modal points-detail-modal">
        <div class="modal-content">
            <span class="close" onclick="guessGame.closePointsDetailModal()">&times;</span>
            <h2>💰 积分明细</h2>
            
            <!-- 积分汇总 -->
            <div class="points-summary">
                <div class="summary-item">
                    <div class="summary-label">当前余额</div>
                    <div class="summary-value" id="currentPointsDisplay">0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">总收入</div>
                    <div class="summary-value" id="totalIncomeDisplay">+0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">总支出</div>
                    <div class="summary-value" id="totalExpenseDisplay">-0</div>
                </div>
            </div>
            
            <!-- 明细列表 -->
            <div class="points-detail-header">
                <h3>交易记录</h3>
            </div>
            <div class="points-detail-list" id="pointsDetailList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
    </div>

        <!-- 主要内容区域 -->
        <main>
            <!-- 所有投票项目卡片 - 置顶 -->
            <div class="card-container">
                <div class="card" id="projects-card">
                    <div class="card-header" onclick="toggleCard('projects-card')">
                        <h2>🏆 所有项目 <span id="allProjectsStats" class="stats-badge"></span></h2>
                        <span class="card-toggle">▼</span>
                    </div>
                    <div class="card-content collapsed">
                        <div class="project-stats">
                            <div class="stat-item">
                                <span class="stat-number" id="totalProjects">0</span>
                                <span class="stat-label">进行中</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="totalParticipants">0</span>
                                <span class="stat-label">总参与</span>
                            </div>
                        </div>
                        <div id="projectsList" class="projects-grid">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 我的投票项目卡片 -->
            <div class="card-container">
                <div class="card" id="my-projects-card">
                    <div class="card-header" onclick="toggleCard('my-projects-card')">
                        <h2>➕ 创建项目</h2>
                        <span class="card-toggle">▼</span>
                    </div>
                    <div class="card-content collapsed">
                        <div class="create-tips">
                            <p class="tip-text">💡 <strong>创建提示：</strong>任何人都可以创建投票项目，系统默认提供"是"和"否"两个选项。<strong>发起人请务必先查看所有游戏规则！</strong></p>
                        </div>
                        <form id="createProjectForm" class="create-form">
                            <div class="form-group">
                                <label for="projectTitle">项目标题</label>
                                <input type="text" id="projectTitle" placeholder="输入投票项目标题" required>
                            </div>
                            <div class="form-group">
                                <label for="projectDescription">项目描述</label>
                                <textarea id="projectDescription" placeholder="详细描述投票项目" rows="4" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="maxPoints">最高投票积分设置</label>
                                <input type="number" id="maxPoints" placeholder="设置单个选项最高可投票积分" min="1" max="1000000" value="10000" required>
                                <small style="color: rgba(255, 255, 255, 0.8); text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);">当任一选项达到此积分上限时，该选项将停止接受新投票</small>
                            </div>
                            <div class="form-group">
                                <label>投票选项（固定）</label>
                                <div class="options-display">
                                    <div class="option-item">✓ 是</div>
                                    <div class="option-item">✗ 否</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="deadline">截止时间</label>
                                <input type="datetime-local" id="deadline" required>
                            </div>
                            <button type="submit" class="btn btn-primary">创建投票项目</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 我的项目卡片 -->
            <div class="card-container">
                <div class="card" id="my-projects-card">
                    <div class="card-header" onclick="toggleCard('my-projects-card')">
                        <h2>📁 我的项目</h2>
                        <span class="card-toggle">▼</span>
                    </div>
                    <div class="card-content collapsed">
                        <!-- 子卡片区域 -->
                        <div class="sub-section">
                            <!-- 我创建的项目 -->
                            <div class="sub-card created-projects" id="created-projects-card">
                                <div class="sub-card-header" onclick="toggleSubCard('created-projects-card')">
                                    <h3 class="sub-card-title">我创建的项目 <span id="createdProjectsStats" class="stats-badge">0</span></h3>
                                    <span class="sub-card-toggle">▼</span>
                                </div>
                                <div class="sub-card-content collapsed">
                                    <div id="createdProjectsList" class="projects-grid">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">📝</div>
                                            <h3>暂无创建的项目</h3>
                                            <p>创建您的第一个投票项目吧！</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 我参与的项目 -->
                            <div class="sub-card participated-projects" id="participated-projects-card">
                                <div class="sub-card-header" onclick="toggleSubCard('participated-projects-card')">
                                    <h3 class="sub-card-title">我参与的项目 <span id="participatedProjectsStats" class="stats-badge">0</span></h3>
                                    <span class="sub-card-toggle">▼</span>
                                </div>
                                <div class="sub-card-content collapsed">
                                    <div id="participatedProjectsList" class="projects-grid">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">🗳️</div>
                                            <h3>暂无参与的项目</h3>
                                            <p>参与投票项目，赢取奖励！</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 游戏规则卡片 -->
            <div class="card-container">
                <div class="card" id="rules-card">
                    <div class="card-header" onclick="toggleCard('rules-card')">
                        <h2>📋 游戏规则</h2>
                        <span class="card-toggle">▼</span>
                    </div>
                    <div class="card-content collapsed">
                        <div class="rules-content">
                            <div class="rule-section">
                                <h3>🎯 基本规则</h3>
                                <ul class="rule-list">
                                    <li>任何用户都可以创建自己的投票项目</li>
                                    <li>所创建的项目的最终结果只能选择是或否</li>
                                    <li>每个项目都可以多次投票</li>
                                    <li>用户投票后不可撤销，项目发起后，无人参与的状态下发起人可以删除，只要有人参与就不能删除此项目</li>
                                    <li>只有项目创建者可以公布结果</li>
                                </ul>
                            </div>
                            
                            <div class="rule-section">
                                <h3>💰 积分规则</h3>
                                <ul class="rule-list">
                                    <li>创建项目时可以设置单个选项的最高投票积分上限，当任一选项达到此积分上限时，该选项将停止接受新投票，用户只能投票给另一个选项</li>
                                    <li>创建10000分的项目，账户就要有10000可用积分，积分不足请充值</li>
                                    <li>点击创建后系统自动冻结发起人账户的相应积分</li>
                                    <li>用户投票后的积分自动转移到此项目发起人账户，默认保持冻结状态，项目正常完结后才能解冻</li>
                                    <li>投票正确的用户将获得双倍积分奖励</li>
                                    <li>项目正常完结后，投票错误的用户已经转移到发起人账户的积分将自动解冻，投票正确的用户所得积分直接从项目发起人账户自动划转到对应的用户账户</li>
                                </ul>
                            </div>
                            
                            <div class="rule-section">
                                <h3>⏰ 时间规则</h3>
                                <ul class="rule-list">
                                    <li>项目截止时间到了以后请及时公布正确结果</li>
                                    <li>超时3小时未公布结果，系统直接按原路退回所有参与者的积分，扣除项目发起人被冻结的积分60%的比例</li>
                                </ul>
                            </div>
                            
                            <div class="rule-section">
                                <h3>🔍 审核规则</h3>
                                <ul class="rule-list">
                                    <li>公布结果需要提交申请</li>
                                    <li>再次公布错误结果按超时处理</li>
                                    <li>扣除发起人冻结积分的60%</li>
                                </ul>
                            </div>
                            
                            <div class="rule-section">
                                <h3>💎 充值提现</h3>
                                <ul class="rule-list">
                                    <li>兑换比例：1 Pi = 1 积分</li>
                                    <li>充值需要向平台地址转账Pi币，填写转账信息后等待人工审核</li>
                                    <li>用户提现时，只可提现未冻结状态的积分，冻结状态的积分不可提现</li>
                                    <li>提现需要提供有效的Pi钱包地址，系统审核后发放</li>
                                    <li>提现收取10%手续费</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 投票模态框 -->
    <div id="voteModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="modalTitle"></h3>
            <p id="modalDescription"></p>
            <div id="modalOptions" class="modal-options">
                <!-- 选项将动态添加 -->
            </div>
            <div class="vote-points-container">
                <label for="votePoints">投票积分：</label>
                <input type="number" id="votePoints" min="1" value="10" placeholder="输入投票积分">
                <span class="current-balance">当前积分: <span id="modalPointsBalance">0</span></span>
            </div>
            <div class="vote-warning">
                <p class="warning-text">⚠️ <strong>重要提醒：</strong>一旦投票提交将无法撤销，只能等待项目发起人公布结果</p>
            </div>
            <div class="vote-submit-container">
                <button id="submitVote" class="btn btn-primary">提交投票</button>
            </div>
        </div>
    </div>

    <!-- 结果模态框 -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>投票结果</h3>
            <div id="resultContent">
                <!-- 结果将动态添加 -->
            </div>
        </div>
    </div>

    <!-- 充值模态框 -->
    <div id="rechargeModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>🥧 充值积分</h3>
            <div class="recharge-form">
                <div class="balance-display">
                    <p>当前积分余额: <span id="rechargeModalPointsBalance">0</span> 积分</p>
                </div>
                <div class="exchange-rate">
                    <p class="rate-info">兑换比例: 1 Pi = 1 积分</p>
                </div>
                
                <!-- 收币地址显示 -->
                <div class="receive-address">
                    <label>平台收币地址：</label>
                    <div class="address-container">
                        <input type="text" id="platformAddress" readonly value="GA7QYNF7SOWQ3GLR2BGMZEHXAVIRZA4KVWLTJJFC7MGXUA74P7UJVSGZ">
                        <button id="copyAddress" class="btn btn-copy">复制</button>
                    </div>
                    <p class="address-note">请复制此地址到您的Pi钱包进行转账</p>
                </div>
                
                <!-- 转账信息填写 -->
                <div class="transfer-info">
                    <div class="transfer-input transfer-amount-inline">
                        <div class="inline-input-group">
                            <label for="rechargePi">转账Pi币数量：</label>
                            <input type="number" id="rechargePi" min="0.01" step="0.01" placeholder="输入转账的Pi币数量">
                        </div>
                        <p class="convert-info">将获得积分: <span id="convertedPoints">0</span></p>
                    </div>
                    
                    <div class="transfer-input">
                        <label for="senderAddress">您的钱包地址：</label>
                        <input type="text" id="senderAddress" placeholder="输入您的Pi钱包地址">
                    </div>
                    
                    <div class="transfer-input">
                        <label for="transactionHash">交易哈希：</label>
                        <input type="text" id="transactionHash" placeholder="输入转账的交易哈希">
                    </div>
                </div>
                
                <div class="recharge-notice">
                    <p class="notice-text">📋 <strong>充值流程：</strong></p>
                    <ol class="notice-list">
                        <li>复制上方平台收币地址</li>
                        <li>在Pi钱包中向该地址转账</li>
                        <li>填写转账金额、您的钱包地址和交易哈希</li>
                        <li>提交充值申请，等待人工审核</li>
                    </ol>
                </div>
                
                <button id="submitRecharge" class="btn btn-primary">提交充值申请</button>
            </div>
        </div>
    </div>

    <!-- 提现模态框 -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>💰 提现积分</h3>
            <div class="withdraw-form">
                <div class="balance-display">
                    <p>可提现积分: <span id="withdrawModalPointsBalance">0</span> 积分</p>
                    <p class="frozen-notice">冻结积分不可提现</p>
                </div>
                <div class="exchange-rate">
                    <p class="rate-info">兑换比例: 1 积分 = 1 Pi（扣除10%手续费）</p>
                </div>
                
                <div class="withdraw-input">
                    <label for="withdrawPoints">提现积分数量：</label>
                    <input type="number" id="withdrawPoints" min="1" placeholder="输入要提现的积分数量">
                    <p class="convert-info">实际到账Pi币: <span id="convertedPi">0</span></p>
                </div>
                
                <div class="withdraw-input">
                    <label for="withdrawAddress">您的Pi钱包地址：</label>
                    <input type="text" id="withdrawAddress" placeholder="输入您的Pi钱包地址">
                </div>
                
                <div class="withdraw-notice">
                    <p class="notice-text">📋 <strong>提现说明：</strong></p>
                    <ul class="notice-list">
                        <li>提现收取10%手续费</li>
                        <li>只能提现未冻结的积分</li>
                        <li>提现申请需要人工审核</li>
                        <li>审核通过后将转账到您的Pi钱包</li>
                    </ul>
                </div>
                
                <button id="submitWithdraw" class="btn btn-primary">提交提现申请</button>
            </div>
        </div>
    </div>

    <!-- 测试登录模态框 -->
    <div id="testLoginModal" class="modal test-login-modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>🧪 测试登录</h3>
            <p>选择一个测试用户进行登录：</p>
            <div class="user-list" id="testUserList">
                <!-- 测试用户列表将动态生成 -->
            </div>
            <div class="test-actions">
                <button id="addTestUser" class="btn btn-secondary">添加测试用户</button>
                <button id="clearTestData" class="btn btn-danger">清空测试数据</button>
            </div>
        </div>
    </div>

    <!-- 固定登录按钮（移动端优化） -->
    <div id="fixedLoginBtn" class="fixed-login-btn" style="display: none;">
        <button class="btn btn-primary" onclick="guessGame.login()">🔐 登录</button>
    </div>

    <script>
        // Pi SDK 初始化
        Pi.init({ 
            version: "2.0", 
            sandbox: false // 设置为 false 使用正式环境，true 使用沙盒环境
        });
        
        // Pi App 配置
        const PI_APP_CONFIG = {
            appId: '6f104bbc3618606c', // 您的 Pi App ID
            scopes: ['username', 'payments'], // 请求的权限范围
            sandbox: false // 是否使用沙盒环境
        };
        
        console.log('Pi SDK 已初始化，App ID:', PI_APP_CONFIG.appId);
        
        // 投票游戏平台类
        class GuessGamePlatform {
            constructor() {
                this.projects = [];
                this.votes = [];
                this.users = {};
                this.currentUser = null;
                this.selectedProjectId = null;
                this.selectedOption = null;
                this.pointsHistory = {}; // 积分历史记录
                this.rechargeRequests = []; // 充值请求
                this.withdrawRequests = []; // 提现请求
                this.pendingResults = []; // 待发布结果
                
                // API配置
                this.apiConfig = {
                    baseURL: this.detectEnvironment(),
                    endpoints: {
                        auth: '/api/auth',
                        projects: '/api/projects',
                        votes: '/api/votes',
                        users: '/api/users',
                        points: '/api/points'
                    }
                };
                
                console.log('API配置:', this.apiConfig);
            }
            
            // 检测运行环境
            detectEnvironment() {
                const hostname = window.location.hostname;
                const port = window.location.port;
                
                if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    return `http://${hostname}:3000`; // 本地开发环境
                } else if (hostname.includes('github.io')) {
                    return 'https://your-backend.herokuapp.com'; // GitHub Pages + Heroku
                } else if (hostname.includes('render.com')) {
                    return `https://${hostname}`; // Render环境
                } else {
                    return ''; // 相对路径，适用于同域部署
                }
            }
            
            // 初始化
            async init() {
                console.log('初始化投票游戏平台...');
                
                // 数据迁移（确保兼容性）
                this.migrateProjectData();
                
                // 绑定事件
                this.bindEvents();
                
                // 检查登录状态
                this.checkLoginStatus();
                
                // 渲染项目列表
                await this.renderProjects();
                
                // 设置默认截止时间
                this.setDefaultDeadline();
                
                console.log('投票游戏平台初始化完成');
            }
            
            // 绑定事件
            bindEvents() {
                // 登录/退出按钮
                document.getElementById('loginBtn').addEventListener('click', () => this.login());
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                
                // 充值/提现按钮
                document.getElementById('rechargeBtn').addEventListener('click', () => this.openRechargeModal());
                document.getElementById('withdrawBtn').addEventListener('click', () => this.openWithdrawModal());
                
                // 创建项目表单
                document.getElementById('createProjectForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.createProject();
                });
                
                // 添加选项按钮
                document.getElementById('addOptionBtn').addEventListener('click', () => this.addOption());
                
                // 充值相关
                document.getElementById('rechargePi').addEventListener('input', () => this.updateConvertedPoints());
                
                // 提现相关
                document.getElementById('withdrawPoints').addEventListener('input', () => this.updateConvertedPi());
                
                // 积分点击事件（延迟绑定，确保元素存在）
                setTimeout(() => {
                    this.bindPointsClickEvent();
                }, 100);
                
                // 自定义警告框按钮
                document.getElementById('customAlertOk').addEventListener('click', () => this.hideCustomAlert());
                
                // 自定义确认框按钮
                document.getElementById('customConfirmOk').addEventListener('click', () => this.hideCustomConfirm(true));
                document.getElementById('customConfirmCancel').addEventListener('click', () => this.hideCustomConfirm(false));
                
                // 自定义输入框按钮
                document.getElementById('customPromptOk').addEventListener('click', () => {
                    const value = document.getElementById('customPromptInput').value.trim();
                    this.hideCustomPrompt(value || null);
                });
                document.getElementById('customPromptCancel').addEventListener('click', () => this.hideCustomPrompt(null));
            }
            
            // 绑定积分点击事件（移动端优化）
            bindPointsClickEvent() {
                const pointsBalance = document.getElementById('pointsBalance');
                if (pointsBalance) {
                    console.log('绑定积分点击事件（移动端优化版本）');
                    
                    // 移除之前的事件监听器（避免重复绑定）
                    pointsBalance.removeEventListener('click', this.pointsClickHandler);
                    pointsBalance.removeEventListener('touchend', this.pointsTouchHandler);
                    
                    // PC端点击事件
                    this.pointsClickHandler = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('积分余额被点击（PC端）');
                        this.openPointsDetailModal();
                    };
                    
                    // 移动端触摸事件
                    this.pointsTouchHandler = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('积分余额被触摸（移动端）');
                        this.openPointsDetailModal();
                    };
                    
                    pointsBalance.addEventListener('click', this.pointsClickHandler);
                    
                    // 移动端特殊处理
                    if ('ontouchstart' in window) {
                        pointsBalance.addEventListener('touchend', this.pointsTouchHandler, { passive: false });
                        
                        // 添加视觉反馈
                        pointsBalance.style.cursor = 'pointer';
                        pointsBalance.style.userSelect = 'none';
                        pointsBalance.style.webkitUserSelect = 'none';
                        pointsBalance.style.webkitTouchCallout = 'none';
                        
                        // 触摸反馈
                        pointsBalance.addEventListener('touchstart', (e) => {
                            pointsBalance.style.transform = 'scale(0.95)';
                        }, { passive: true });
                        
                        pointsBalance.addEventListener('touchcancel', (e) => {
                            pointsBalance.style.transform = 'scale(1)';
                        }, { passive: true });
                    }
                    
                    console.log('积分点击事件绑定完成（移动端优化）');
                } else {
                    console.warn('积分余额元素未找到，无法绑定点击事件');
                }
            }
            
            // 绑定模态框关闭事件（移动端优化）
            bindModalCloseEvents() {
                const modal = document.getElementById('pointsDetailModal');
                if (!modal) return;
                
                // 点击背景关闭
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        console.log('点击背景关闭积分明细');
                        this.closePointsDetailModal();
                    }
                });
                
                // ESC键关闭
                const escHandler = (e) => {
                    if (e.key === 'Escape' && modal.style.display === 'block') {
                        console.log('ESC键关闭积分明细');
                        this.closePointsDetailModal();
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
             }
             
             // 检查登录状态
             checkLoginStatus() {
                 const savedUser = localStorage.getItem('currentUser');
                 if (savedUser) {
                     this.currentUser = JSON.parse(savedUser);
                     this.updateUserDisplay();
                 }
             }
             
             // Pi SDK登录
             async login() {
                 console.log('开始Pi SDK登录流程...');
                 console.log('使用App ID:', PI_APP_CONFIG.appId);
                 
                 try {
                     // 检查Pi SDK是否可用
                     if (typeof Pi === 'undefined') {
                         console.error('Pi SDK未加载');
                         this.showCustomAlert('请在Pi浏览器中打开此应用');
                         return;
                     }
                     
                     console.log('Pi SDK状态检查...');
                     
                     // 检查Pi SDK是否已初始化
                     try {
                         // 使用配置的参数重新初始化（确保使用正确的配置）
                         await Pi.init({ 
                             version: "2.0", 
                             sandbox: PI_APP_CONFIG.sandbox 
                         });
                         console.log('Pi SDK初始化成功，环境:', PI_APP_CONFIG.sandbox ? '沙盒' : '正式');
                     } catch (error) {
                         console.error('Pi SDK初始化失败:', error);
                         throw new Error('Pi SDK初始化失败，请刷新页面重试');
                     }
                     
                     console.log('开始Pi用户认证...');
                     console.log('请求权限范围:', PI_APP_CONFIG.scopes);
                     
                     // 进行用户认证，使用配置的权限范围
                     const authResult = await Pi.authenticate(PI_APP_CONFIG.scopes, this.onIncompletePaymentFound.bind(this));
                     
                     console.log('Pi认证结果:', authResult);
                     
                     if (authResult.accessToken) {
                         console.log('Pi认证成功，继续后端验证...');
                         await this.continueLoginWithPi(authResult);
                     } else {
                         throw new Error('Pi认证失败：未获取到访问令牌');
                     }
                     
                 } catch (error) {
                     console.error('Pi登录过程中发生错误:', error);
                     
                     let errorMessage = '登录失败';
                     if (error.message.includes('SDK')) {
                         errorMessage = '请在Pi浏览器中打开此应用';
                     } else if (error.message.includes('网络')) {
                         errorMessage = '网络连接失败，请检查网络后重试';
                     } else if (error.message.includes('认证')) {
                         errorMessage = 'Pi认证失败，请重试';
                     } else {
                         errorMessage = `登录失败: ${error.message}`;
                     }
                     
                     this.showCustomAlert(errorMessage);
                 }
             }
             
             // 继续Pi登录流程（后端验证）
             async continueLoginWithPi(authResult) {
                 try {
                     console.log('开始后端API验证...');
                     
                     // 构建API请求
                     const apiUrl = `${this.apiConfig.baseURL}${this.apiConfig.endpoints.auth}/pi-login`;
                     const requestData = {
                         accessToken: authResult.accessToken,
                         user: authResult.user,
                         appId: PI_APP_CONFIG.appId // 添加App ID到请求中
                     };
                     
                     console.log('发送API请求到:', apiUrl);
                     console.log('请求数据:', requestData);
                     
                     // 发送到后端验证
                     const response = await fetch(apiUrl, {
                         method: 'POST',
                         headers: {
                             'Content-Type': 'application/json',
                         },
                         body: JSON.stringify(requestData)
                     });
                     
                     console.log('API响应状态:', response.status);
                     
                     if (!response.ok) {
                         const errorText = await response.text();
                         console.error('API响应错误:', errorText);
                         throw new Error(`后端验证失败: ${response.status} ${errorText}`);
                     }
                     
                     const result = await response.json();
                     console.log('后端验证成功:', result);
                     
                     // 保存用户信息
                     this.currentUser = {
                         uid: result.user.uid,
                         username: result.user.username,
                         points: result.user.points || 100, // 新用户默认100积分
                         accessToken: authResult.accessToken,
                         loginTime: new Date().toISOString()
                     };
                     
                     // 保存到本地存储
                     localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                     
                     // 更新用户显示
                     this.updateUserDisplay();
                     
                     // 重新渲染项目（显示用户相关的投票状态）
                     await this.renderProjects();
                     
                     console.log('Pi登录流程完成');
                     this.showCustomAlert(`欢迎回来，${this.currentUser.username}！`);
                     
                 } catch (error) {
                     console.error('后端验证过程中发生错误:', error);
                     
                     // 如果是网络错误，使用本地模拟登录
                     if (error.message.includes('fetch') || error.message.includes('网络') || error.message.includes('Failed to fetch')) {
                         console.log('网络错误，使用本地模拟登录');
                         await this.simulateLocalLogin(authResult);
                     } else {
                         throw error; // 重新抛出其他类型的错误
                     }
                 }
             }
             
             // 本地模拟登录（用于开发和网络问题时的备用方案）
             async simulateLocalLogin(authResult) {
                 console.log('执行本地模拟登录...');
                 
                 // 从本地存储获取或创建用户数据
                 const existingUsers = JSON.parse(localStorage.getItem('users') || '{}');
                 const uid = authResult.user.uid;
                 
                 if (existingUsers[uid]) {
                     // 现有用户
                     this.currentUser = existingUsers[uid];
                     this.currentUser.accessToken = authResult.accessToken;
                     this.currentUser.loginTime = new Date().toISOString();
                 } else {
                     // 新用户
                     this.currentUser = {
                         uid: uid,
                         username: authResult.user.username,
                         points: 100, // 新用户默认100积分
                         accessToken: authResult.accessToken,
                         loginTime: new Date().toISOString()
                     };
                     
                     // 保存新用户到本地用户列表
                     existingUsers[uid] = this.currentUser;
                     localStorage.setItem('users', JSON.stringify(existingUsers));
                 }
                 
                 // 保存当前用户
                 localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                 
                 // 更新用户显示
                 this.updateUserDisplay();
                 
                 // 重新渲染项目
                 await this.renderProjects();
                 
                 console.log('本地模拟登录完成');
                 this.showCustomAlert(`欢迎，${this.currentUser.username}！（本地模式）`);
             }
             
             // 处理未完成的支付
             onIncompletePaymentFound(payment) {
                 console.log('发现未完成的支付:', payment);
                 // 这里可以处理未完成的支付逻辑
                 // 例如：显示支付状态，允许用户完成支付等
             }
             
             // 退出登录
             logout() {
                 console.log('用户退出登录');
                 
                 this.currentUser = null;
                 localStorage.removeItem('currentUser');
                 
                 // 更新UI
                 this.updateUserDisplay();
                 
                 // 重新渲染项目（隐藏用户相关信息）
                 this.renderProjects();
                 
                 this.showCustomAlert('已退出登录');
             }
             
             // 更新用户显示
             updateUserDisplay() {
                 const loginSection = document.getElementById('loginSection');
                 const userSection = document.getElementById('userSection');
                 const loginBtn = document.getElementById('loginBtn');
                 const logoutBtn = document.getElementById('logoutBtn');
                 const usernameSpan = document.getElementById('username');
                 const pointsBalance = document.getElementById('pointsBalance');
                 const rechargeBtn = document.getElementById('rechargeBtn');
                 const withdrawBtn = document.getElementById('withdrawBtn');
                 
                 if (this.currentUser) {
                     // 已登录状态
                     loginSection.style.display = 'none';
                     userSection.style.display = 'block';
                     loginBtn.style.display = 'none';
                     logoutBtn.style.display = 'inline-block';
                     usernameSpan.textContent = this.currentUser.username;
                     pointsBalance.textContent = this.currentUser.points || 0;
                     
                     // 重新绑定积分点击事件（确保用户信息更新后事件正常）
                     setTimeout(() => {
                         this.bindPointsClickEvent();
                     }, 100);
                 } else {
                     // 未登录状态
                     loginSection.style.display = 'block';
                     userSection.style.display = 'none';
                     loginBtn.style.display = 'inline-block';
                     logoutBtn.style.display = 'none';
                 }
             }
             
             // 验证积分一致性
             validatePointsConsistency() {
                 if (!this.currentUser) return;
                 
                 const history = this.pointsHistory[this.currentUser.uid] || [];
                 let calculatedPoints = 100; // 初始积分
                 
                 history.forEach(record => {
                     if (record.type === 'recharge' || record.type === 'reward') {
                         calculatedPoints += record.amount;
                     } else if (record.type === 'withdraw' || record.type === 'vote' || record.type === 'penalty') {
                         calculatedPoints -= record.amount;
                     }
                 });
                 
                 if (Math.abs(calculatedPoints - this.currentUser.points) > 0.01) {
                     console.warn('积分不一致！计算值:', calculatedPoints, '当前值:', this.currentUser.points);
                     // 可以选择修正或记录错误
                     this.currentUser.points = calculatedPoints;
                     this.updateUserDisplay();
                     localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                 }
             }
             
             // 设置默认截止时间（24小时后）
             setDefaultDeadline() {
                 const deadlineInput = document.getElementById('deadline');
                 if (deadlineInput) {
                     const tomorrow = new Date();
                     tomorrow.setDate(tomorrow.getDate() + 1);
                     deadlineInput.value = tomorrow.toISOString().slice(0, 16);
                 }
             }
             
             // 打开充值模态框
             openRechargeModal() {
                 if (!this.currentUser) {
                     this.showCustomAlert('请先登录');
                     return;
                 }
                 
                 document.getElementById('rechargeModal').style.display = 'block';
                 document.getElementById('rechargePi').value = '';
                 document.getElementById('convertedPoints').textContent = '0';
             }
             
             // 更新转换后的积分显示
             updateConvertedPoints() {
                 const piAmount = parseFloat(document.getElementById('rechargePi').value) || 0;
                 const points = piAmount * 100; // 1 Pi = 100 积分
                 document.getElementById('convertedPoints').textContent = points.toFixed(0);
             }
             
             // 复制充值地址
             copyRechargeAddress() {
                 const address = 'GB6YPGW5JFMMP2QB2USQ33EUWTXVL4ZT5ITUNCY3YKVWOJVMD3BWJBQH';
                 
                 if (navigator.clipboard && navigator.clipboard.writeText) {
                     navigator.clipboard.writeText(address).then(() => {
                         this.showCustomAlert('地址已复制到剪贴板');
                     }).catch(err => {
                         console.error('复制失败:', err);
                         this.fallbackCopyText(address);
                     });
                 } else {
                     this.fallbackCopyText(address);
                 }
             }
             
             // 备用复制方法
             fallbackCopyText(text) {
                 const textArea = document.createElement('textarea');
                 textArea.value = text;
                 textArea.style.position = 'fixed';
                 textArea.style.left = '-999999px';
                 textArea.style.top = '-999999px';
                 document.body.appendChild(textArea);
                 textArea.focus();
                 textArea.select();
                 
                 try {
                     document.execCommand('copy');
                     this.showCustomAlert('地址已复制到剪贴板');
                 } catch (err) {
                     console.error('复制失败:', err);
                     this.showCustomAlert('复制失败，请手动复制地址');
                 } finally {
                     document.body.removeChild(textArea);
                 }
             }
             
             // 提交充值请求
             async submitRecharge() {
                 const piAmount = parseFloat(document.getElementById('rechargePi').value);
                 
                 if (!piAmount || piAmount <= 0) {
                     this.showCustomAlert('请输入有效的Pi数量');
                     return;
                 }
                 
                 if (piAmount < 0.1) {
                     this.showCustomAlert('最小充值金额为0.1 Pi');
                     return;
                 }
                 
                 const confirmed = await this.showCustomConfirm(`确定要充值 ${piAmount} Pi 吗？\n\n请确保您已经向指定地址转账相应的Pi币。`);
                 if (!confirmed) return;
                 
                 // 创建充值请求
                 const rechargeRequest = {
                     id: Date.now().toString(),
                     userId: this.currentUser.uid,
                     username: this.currentUser.username,
                     piAmount: piAmount,
                     points: piAmount * 100,
                     status: 'pending',
                     createTime: new Date().toISOString(),
                     txHash: null // 实际应用中需要用户提供交易哈希
                 };
                 
                 // 保存充值请求
                 this.rechargeRequests.push(rechargeRequest);
                 localStorage.setItem('rechargeRequests', JSON.stringify(this.rechargeRequests));
                 
                 // 模拟自动完成充值（实际应用中需要管理员审核）
                 setTimeout(() => {
                     this.completeRecharge(rechargeRequest.id);
                 }, 2000);
                 
                 // 关闭模态框
                 document.getElementById('rechargeModal').style.display = 'none';
                 
                 this.showCustomAlert('充值请求已提交，请等待处理...');
             }
             
             // 完成充值
             completeRecharge(requestId) {
                 const request = this.rechargeRequests.find(r => r.id === requestId);
                 if (!request || request.status !== 'pending') return;
                 
                 // 更新用户积分
                 this.currentUser.points += request.points;
                 localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                 
                 // 记录积分历史
                 this.addPointsRecord(this.currentUser.uid, {
                     type: 'recharge',
                     amount: request.points,
                     description: `充值 ${request.piAmount} Pi`,
                     relatedId: requestId
                 });
                 
                 // 更新请求状态
                 request.status = 'completed';
                 request.completeTime = new Date().toISOString();
                 localStorage.setItem('rechargeRequests', JSON.stringify(this.rechargeRequests));
                 
                 // 更新显示
                 this.updateUserDisplay();
                 
                 this.showCustomAlert(`充值成功！获得 ${request.points} 积分`);
             }
             
             // 打开提现模态框
             openWithdrawModal() {
                 if (!this.currentUser) {
                     this.showCustomAlert('请先登录');
                     return;
                 }
                 
                 document.getElementById('withdrawModal').style.display = 'block';
                 document.getElementById('withdrawPoints').value = '';
                 document.getElementById('convertedPi').textContent = '0';
                 document.getElementById('withdrawAddress').value = '';
             }
             
             // 更新转换后的Pi显示
             updateConvertedPi() {
                 const points = parseFloat(document.getElementById('withdrawPoints').value) || 0;
                 const pi = points / 100; // 100 积分 = 1 Pi
                 document.getElementById('convertedPi').textContent = pi.toFixed(2);
             }
             
             // 验证Pi地址格式
             validatePiAddress(address) {
                 // 简单的Pi地址格式验证（实际应用中需要更严格的验证）
                 const piAddressRegex = /^G[A-Z0-9]{55}$/;
                 return piAddressRegex.test(address);
             }
             
             // 提交提现请求
             async submitWithdraw() {
                 const points = parseFloat(document.getElementById('withdrawPoints').value);
                 const address = document.getElementById('withdrawAddress').value.trim();
                 
                 if (!points || points <= 0) {
                     this.showCustomAlert('请输入有效的积分数量');
                     return;
                 }
                 
                 if (points < 100) {
                     this.showCustomAlert('最小提现金额为100积分');
                     return;
                 }
                 
                 if (!address) {
                     this.showCustomAlert('请输入Pi钱包地址');
                     return;
                 }
                 
                 if (!this.validatePiAddress(address)) {
                     this.showCustomAlert('Pi钱包地址格式不正确');
                     return;
                 }
                 
                 if (points > this.currentUser.points) {
                     this.showCustomAlert('积分余额不足');
                     return;
                 }
                 
                 const pi = points / 100;
                 const confirmed = await this.showCustomConfirm(`确定要提现 ${points} 积分（${pi} Pi）吗？\n\n提现地址：${address}`);
                 if (!confirmed) return;
                 
                 // 计算冻结积分（提现手续费等）
                 const fee = Math.max(10, points * 0.02); // 最低10积分手续费，或2%
                 const totalDeduction = points + fee;
                 
                 if (totalDeduction > this.currentUser.points) {
                     this.showCustomAlert(`积分余额不足（需要 ${totalDeduction} 积分，包含手续费 ${fee} 积分）`);
                     return;
                 }
                 
                 // 创建提现请求
                 const withdrawRequest = {
                     id: Date.now().toString(),
                     userId: this.currentUser.uid,
                     username: this.currentUser.username,
                     points: points,
                     piAmount: pi,
                     fee: fee,
                     address: address,
                     status: 'pending',
                     createTime: new Date().toISOString()
                 };
                 
                 // 扣除积分（包含手续费）
                 this.currentUser.points -= totalDeduction;
                 localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                 
                 // 记录积分历史
                 this.addPointsRecord(this.currentUser.uid, {
                     type: 'withdraw',
                     amount: totalDeduction,
                     description: `提现 ${pi} Pi（含手续费 ${fee} 积分）`,
                     relatedId: withdrawRequest.id
                 });
                 
                 // 保存提现请求
                 this.withdrawRequests.push(withdrawRequest);
                 localStorage.setItem('withdrawRequests', JSON.stringify(this.withdrawRequests));
                 
                 // 关闭模态框
                 document.getElementById('withdrawModal').style.display = 'none';
                 
                 // 更新显示
                 this.updateUserDisplay();
                 
                 this.showCustomAlert('提现请求已提交，请等待处理...');
             }
             
             // 管理员功能：打开提现请求管理
             openWithdrawRequests() {
                 // 这里可以实现管理员查看和处理提现请求的功能
                 console.log('提现请求:', this.withdrawRequests);
             }
             
             // 管理员功能：关闭提现请求管理
             closeWithdrawRequests() {
                 // 实现关闭提现请求管理界面
             }
             
             // 管理员功能：加载提现请求
             loadWithdrawRequests() {
                 const requests = JSON.parse(localStorage.getItem('withdrawRequests') || '[]');
                 this.withdrawRequests = requests;
                 return requests;
             }
             
             // 管理员功能：批准提现
             approveWithdraw(requestId) {
                 const request = this.withdrawRequests.find(r => r.id === requestId);
                 if (!request || request.status !== 'pending') return;
                 
                 request.status = 'approved';
                 request.approveTime = new Date().toISOString();
                 localStorage.setItem('withdrawRequests', JSON.stringify(this.withdrawRequests));
                 
                 console.log('提现请求已批准:', request);
             }
             
             // 管理员功能：拒绝提现
             rejectWithdraw(requestId, reason) {
                 const request = this.withdrawRequests.find(r => r.id === requestId);
                 if (!request || request.status !== 'pending') return;
                 
                 // 退还积分
                 const users = JSON.parse(localStorage.getItem('users') || '{}');
                 if (users[request.userId]) {
                     users[request.userId].points += (request.points + request.fee);
                     localStorage.setItem('users', JSON.stringify(users));
                     
                     // 如果是当前用户，更新显示
                     if (this.currentUser && this.currentUser.uid === request.userId) {
                         this.currentUser.points += (request.points + request.fee);
                         localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                         this.updateUserDisplay();
                     }
                 }
                 
                 request.status = 'rejected';
                 request.rejectTime = new Date().toISOString();
                 request.rejectReason = reason;
                 localStorage.setItem('withdrawRequests', JSON.stringify(this.withdrawRequests));
                 
                 console.log('提现请求已拒绝:', request);
             }
             
             // 处理超时项目
             handleTimeoutProjects() {
                 const now = new Date();
                 const timeoutProjects = this.projects.filter(project => {
                     const deadline = new Date(project.deadline);
                     return deadline < now && project.status === 'active' && !project.result;
                 });
                 
                 timeoutProjects.forEach(project => {
                     this.penalizeTimeoutProject(project);
                 });
             }
             
             // 惩罚超时项目
             penalizeTimeoutProject(project) {
                 console.log('处理超时项目:', project.title);
                 
                 // 标记项目为超时
                 project.status = 'timeout';
                 project.timeoutTime = new Date().toISOString();
                 
                 // 惩罚创建者（扣除一定积分）
                 const penalty = Math.min(50, project.totalVotes * 2); // 最多扣50积分
                 const users = JSON.parse(localStorage.getItem('users') || '{}');
                 
                 if (users[project.creatorId]) {
                     users[project.creatorId].points = Math.max(0, users[project.creatorId].points - penalty);
                     localStorage.setItem('users', JSON.stringify(users));
                     
                     // 记录惩罚
                     this.addPointsRecord(project.creatorId, {
                         type: 'penalty',
                         amount: penalty,
                         description: `项目超时惩罚：${project.title}`,
                         relatedId: project.id
                     });
                     
                     // 如果是当前用户，更新显示
                     if (this.currentUser && this.currentUser.uid === project.creatorId) {
                         this.currentUser.points = users[project.creatorId].points;
                         localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                         this.updateUserDisplay();
                     }
                 }
                 
                 // 退还参与者积分
                 const projectVotes = this.votes.filter(vote => vote.projectId === project.id);
                 projectVotes.forEach(vote => {
                     if (users[vote.userId]) {
                         users[vote.userId].points += vote.points;
                         
                         // 记录退款
                         this.addPointsRecord(vote.userId, {
                             type: 'refund',
                             amount: vote.points,
                             description: `项目超时退款：${project.title}`,
                             relatedId: project.id
                         });
                         
                         // 如果是当前用户，更新显示
                         if (this.currentUser && this.currentUser.uid === vote.userId) {
                             this.currentUser.points = users[vote.userId].points;
                             localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                             this.updateUserDisplay();
                         }
                     }
                 });
                 
                 localStorage.setItem('users', JSON.stringify(users));
                 localStorage.setItem('projects', JSON.stringify(this.projects));
             }
             
             // 删除项目（创建者）
             async deleteProject(projectId) {
                 if (!this.currentUser) {
                     this.showCustomAlert('请先登录');
                     return;
                 }
                 
                 const project = this.projects.find(p => p.id === projectId);
                 if (!project) {
                     this.showCustomAlert('项目不存在');
                     return;
                 }
                 
                 if (project.creatorId !== this.currentUser.uid) {
                     this.showCustomAlert('只能删除自己创建的项目');
                     return;
                 }
                 
                 // 检查项目状态
                 if (project.status === 'active' && project.totalVotes > 0) {
                     this.showCustomAlert('有投票的活跃项目无法删除');
                     return;
                 }
                 
                 const confirmed = await this.showCustomConfirm(`确定要删除项目「${project.title}」吗？`);
                 if (!confirmed) return;
                 
                 // 删除项目
                 this.projects = this.projects.filter(p => p.id !== projectId);
                 localStorage.setItem('projects', JSON.stringify(this.projects));
                 
                 // 删除相关投票
                 this.votes = this.votes.filter(v => v.projectId !== projectId);
                 localStorage.setItem('votes', JSON.stringify(this.votes));
                 
                 // 如果有冻结积分，释放给参与者
                 const projectVotes = this.votes.filter(vote => vote.projectId === projectId);
                 if (projectVotes.length > 0) {
                     const users = JSON.parse(localStorage.getItem('users') || '{}');
                     projectVotes.forEach(vote => {
                         if (users[vote.userId]) {
                             users[vote.userId].points += vote.points;
                             
                             // 记录退款
                             this.addPointsRecord(vote.userId, {
                                 type: 'refund',
                                 amount: vote.points,
                                 description: `项目删除退款：${project.title}`,
                                 relatedId: projectId
                             });
                         }
                     });
                     localStorage.setItem('users', JSON.stringify(users));
                 }
                 
                 // 重新渲染
                 await this.renderProjects();
                 
                 this.showCustomAlert('项目已删除');
             }
             
             // 删除参与的项目（投票记录）
             async deleteParticipatedProject(projectId) {
                 if (!this.currentUser) {
                     this.showCustomAlert('请先登录');
                     return;
                 }
                 
                 const userVotes = this.votes.filter(v => v.projectId === projectId && v.userId === this.currentUser.uid);
                 if (userVotes.length === 0) {
                     this.showCustomAlert('您没有参与此项目');
                     return;
                 }
                 
                 const project = this.projects.find(p => p.id === projectId);
                 const confirmed = await this.showCustomConfirm(`确定要删除在项目「${project?.title || '未知项目'}」中的投票记录吗？`);
                 if (!confirmed) return;
                 
                 // 删除用户的投票记录
                 this.votes = this.votes.filter(v => !(v.projectId === projectId && v.userId === this.currentUser.uid));
                 localStorage.setItem('votes', JSON.stringify(this.votes));
                 
                 // 重新渲染
                 await this.renderProjects();
                 
                 this.showCustomAlert('投票记录已删除');
             }
             
             // 打开发布结果请求
             openPublishResultRequest(projectId) {
                 if (!this.currentUser) {
                     this.showCustomAlert('请先登录');
                     return;
                 }
                 
                 const project = this.projects.find(p => p.id === projectId);
                 if (!project) {
                     this.showCustomAlert('项目不存在');
                     return;
                 }
                 
                 if (project.creatorId !== this.currentUser.uid) {
                     this.showCustomAlert('只能发布自己创建的项目结果');
                     return;
                 }
                 
                 if (project.result) {
                     this.showCustomAlert('项目结果已发布');
                     return;
                 }
                 
                 // 设置选中的项目
                 this.selectedProjectId = projectId;
                 
                 // 显示发布结果模态框
                 document.getElementById('publishResultModal').style.display = 'block';
                 
                 // 清空之前的选择
                 const radioButtons = document.querySelectorAll('input[name="correctOption"]');
                 radioButtons.forEach(radio => radio.checked = false);
                 
                 // 动态生成选项
                 const optionsContainer = document.getElementById('resultOptions');
                 optionsContainer.innerHTML = '';
                 
                 project.options.forEach((option, index) => {
                     const optionDiv = document.createElement('div');
                     optionDiv.className = 'option-item';
                     optionDiv.innerHTML = `
                         <input type="radio" id="option${index}" name="correctOption" value="${index}">
                         <label for="option${index}">${option}</label>
                     `;
                     optionsContainer.appendChild(optionDiv);
                 });
             }
             
             // 提交发布结果请求
             async submitPublishResult() {
                 const selectedOption = document.querySelector('input[name="correctOption"]:checked');
                 
                 if (!selectedOption) {
                     this.showCustomAlert('请选择正确答案');
                     return;
                 }
                 
                 const correctOptionIndex = parseInt(selectedOption.value);
                 const project = this.projects.find(p => p.id === this.selectedProjectId);
                 
                 const confirmed = await this.showCustomConfirm(`确定要发布项目「${project.title}」的结果吗？\n\n正确答案：${project.options[correctOptionIndex]}`);
                 if (!confirmed) return;
                 
                 // 创建发布结果请求
                 const publishRequest = {
                     id: Date.now().toString(),
                     projectId: this.selectedProjectId,
                     projectTitle: project.title,
                     creatorId: this.currentUser.uid,
                     correctOption: correctOptionIndex,
                     status: 'pending',
                     createTime: new Date().toISOString()
                 };
                 
                 // 保存发布请求
                 this.pendingResults.push(publishRequest);
                 localStorage.setItem('pendingResults', JSON.stringify(this.pendingResults));
                 
                 // 模拟自动处理（实际应用中可能需要管理员审核）
                 setTimeout(() => {
                     this.processPublishResult(publishRequest.id);
                 }, 1000);
                 
                 // 关闭模态框
                 document.getElementById('publishResultModal').style.display = 'none';
                 
                 this.showCustomAlert('结果发布请求已提交，正在处理...');
             }
             
             // 处理投票奖励
             processVoteRewards(project, correctOptionIndex) {
                 const projectVotes = this.votes.filter(vote => vote.projectId === project.id);
                 const users = JSON.parse(localStorage.getItem('users') || '{}');
                 
                 // 计算正确和错误投票
                 const correctVotes = projectVotes.filter(vote => vote.selectedOption === correctOptionIndex);
                 const incorrectVotes = projectVotes.filter(vote => vote.selectedOption !== correctOptionIndex);
                 
                 // 计算奖励池（错误投票的积分）
                 const rewardPool = incorrectVotes.reduce((total, vote) => total + vote.points, 0);
                 
                 // 给正确投票者发放奖励（双倍返还）
                 correctVotes.forEach(vote => {
                     if (users[vote.userId]) {
                         const reward = vote.points * 2; // 双倍返还
                         users[vote.userId].points += reward;
                         
                         // 记录奖励
                         this.addPointsRecord(vote.userId, {
                             type: 'reward',
                             amount: reward,
                             description: `投票正确奖励：${project.title}`,
                             relatedId: project.id
                         });
                         
                         // 如果是当前用户，更新显示
                         if (this.currentUser && this.currentUser.uid === vote.userId) {
                             this.currentUser.points = users[vote.userId].points;
                             localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                             this.updateUserDisplay();
                         }
                     }
                 });
                 
                 // 创建者获得错误投票的积分作为收入
                 if (users[project.creatorId] && rewardPool > 0) {
                     users[project.creatorId].points += rewardPool;
                     
                     // 记录收入
                     this.addPointsRecord(project.creatorId, {
                         type: 'income',
                         amount: rewardPool,
                         description: `项目收入：${project.title}`,
                         relatedId: project.id
                     });
                     
                     // 如果是当前用户，更新显示
                     if (this.currentUser && this.currentUser.uid === project.creatorId) {
                         this.currentUser.points = users[project.creatorId].points;
                         localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                         this.updateUserDisplay();
                     }
                 }
                 
                 localStorage.setItem('users', JSON.stringify(users));
                 
                 console.log(`奖励处理完成：正确投票 ${correctVotes.length} 人，错误投票 ${incorrectVotes.length} 人，奖励池 ${rewardPool} 积分`);
             }
             
             // 创建项目
             async createProject() {
                 if (!this.currentUser) {
                     this.showCustomAlert('请先登录');
                     return;
                 }
                 
                 const title = document.getElementById('projectTitle').value.trim();
                 const description = document.getElementById('projectDescription').value.trim();
                 const deadline = document.getElementById('deadline').value;
                 const options = Array.from(document.querySelectorAll('.option-input')).map(input => input.value.trim()).filter(option => option);
                 
                 // 验证输入
                 if (!title) {
                     this.showCustomAlert('请输入项目标题');
                     return;
                 }
                 
                 if (!description) {
                     this.showCustomAlert('请输入项目描述');
                     return;
                 }
                 
                 if (!deadline) {
                     this.showCustomAlert('请选择截止时间');
                     return;
                 }
                 
                 if (options.length < 2) {
                     this.showCustomAlert('至少需要2个选项');
                     return;
                 }
                 
                 // 检查截止时间
                 const deadlineDate = new Date(deadline);
                 const now = new Date();
                 if (deadlineDate <= now) {
                     this.showCustomAlert('截止时间必须在未来');
                     return;
                 }
                 
                 try {
                     // 构建项目数据
                     const projectData = {
                         title,
                         description,
                         deadline,
                         options,
                         creatorId: this.currentUser.uid,
                         creatorName: this.currentUser.username
                     };
                     
                     // 尝试发送到后端
                     const apiUrl = `${this.apiConfig.baseURL}${this.apiConfig.endpoints.projects}`;
                     
                     try {
                         const response = await fetch(apiUrl, {
                             method: 'POST',
                             headers: {
                                 'Content-Type': 'application/json',
                                 'Authorization': `Bearer ${this.currentUser.accessToken}`
                             },
                             body: JSON.stringify(projectData)
                         });
                         
                         if (response.ok) {
                             const result = await response.json();
                             console.log('项目创建成功（后端）:', result);
                         } else {
                             throw new Error('后端创建失败');
                         }
                     } catch (error) {
                         console.log('后端创建失败，使用本地存储:', error.message);
                         // 继续使用本地存储
                     }
                     
                     // 本地创建项目
                     const project = {
                         id: Date.now().toString(),
                         ...projectData,
                         status: 'active',
                         createTime: new Date().toISOString(),
                         totalVotes: 0,
                         totalPoints: 0,
                         result: null
                     };
                     
                     // 添加到项目列表
                     this.projects.push(project);
                     localStorage.setItem('projects', JSON.stringify(this.projects));
                     
                     // 清空表单
                     document.getElementById('createProjectForm').reset();
                     document.getElementById('optionsContainer').innerHTML = `
                         <div class="option-group">
                             <input type="text" class="option-input" placeholder="选项1" required>
                         </div>
                         <div class="option-group">
                             <input type="text" class="option-input" placeholder="选项2" required>
                         </div>
                     `;
                     
                     // 重新设置默认截止时间
                     this.setDefaultDeadline();
                     
                     // 重新渲染项目列表
                     await this.renderProjects();
                     
                     this.showCustomAlert('项目创建成功！');
                     
                 } catch (error) {
                     console.error('创建项目时发生错误:', error);
                     this.showCustomAlert('创建项目失败，请重试');
                 }
             }
             
             // 渲染所有项目
             async renderAllProjects() {
                 try {
                     // 尝试从后端获取项目
                     const apiUrl = `${this.apiConfig.baseURL}${this.apiConfig.endpoints.projects}`;
                     
                     try {
                         const response = await fetch(apiUrl, {
                             headers: {
                                 'Authorization': this.currentUser ? `Bearer ${this.currentUser.accessToken}` : ''
                             }
                         });
                         
                         if (response.ok) {
                             const projects = await response.json();
                             console.log('从后端获取项目成功:', projects.length);
                             // 可以选择合并后端和本地数据
                         }
                     } catch (error) {
                         console.log('从后端获取项目失败，使用本地数据:', error.message);
                     }
                     
                     const container = document.getElementById('allProjectsContainer');
                     if (!container) return;
                     
                     if (this.projects.length === 0) {
                         container.innerHTML = `
                             <div class="empty-state">
                                 <p>暂无项目</p>
                                 <p>成为第一个创建项目的人吧！</p>
                             </div>
                         `;
                         return;
                     }
                     
                     // 计算统计信息
                     const activeProjects = this.projects.filter(p => p.status === 'active').length;
                     const totalParticipants = this.votes.length;
                     
                     // 更新统计
                     const statsContainer = document.querySelector('.stats-container');
                     if (statsContainer) {
                         statsContainer.innerHTML = `
                             <div class="stat-item">
                                 <span class="stat-number">${this.projects.length}</span>
                                 <span class="stat-label">总项目</span>
                             </div>
                             <div class="stat-item">
                                 <span class="stat-number">${activeProjects}</span>
                                 <span class="stat-label">进行中</span>
                             </div>
                             <div class="stat-item">
                                 <span class="stat-number">${totalParticipants}</span>
                                 <span class="stat-label">总参与</span>
                             </div>
                         `;
                     }
                     
                     // 渲染项目列表
                     container.innerHTML = this.projects.map(project => {
                         const userVote = this.currentUser ? this.votes.find(v => v.projectId === project.id && v.userId === this.currentUser.uid) : null;
                         const hasVoted = !!userVote;
                         const timeLeft = this.getTimeLeft(project.deadline);
                         const isExpired = new Date(project.deadline) < new Date();
                         
                         return `
                             <div class="project-card">
                                 <div class="project-header">
                                     <h3 class="project-title">${project.title}</h3>
                                     <span class="project-status ${project.status}">${project.status === 'active' ? '进行中' : project.status === 'completed' ? '已完成' : '已过期'}</span>
                                 </div>
                                 
                                 <div class="project-meta">
                                     <span class="participant-count">👥 ${project.totalVotes || 0} 人参与</span>
                                     <span class="time-left">${timeLeft}</span>
                                 </div>
                                 
                                 <p class="project-description">${project.description}</p>
                                 
                                 <div class="project-details">
                                     <p><strong>截止时间：</strong>${new Date(project.deadline).toLocaleString()}</p>
                                     <p><strong>创建者：</strong>${project.creatorName || '未知'}</p>
                                 </div>
                                 
                                 <div class="project-options">
                                     <h4>选项：</h4>
                                     <ul>
                                         ${project.options.map((option, index) => `
                                             <li class="${userVote && userVote.selectedOption === index ? 'user-selected' : ''}">
                                                 ${option}
                                                 ${userVote && userVote.selectedOption === index ? ' ✓' : ''}
                                             </li>
                                         `).join('')}
                                     </ul>
                                 </div>
                                 
                                 <div class="project-actions">
                                     ${!isExpired && project.status === 'active' && this.currentUser ? `
                                         <button class="btn btn-primary" onclick="guessGame.openVoteModal('${project.id}')">
                                             ${hasVoted ? '重新投票' : '投票'}
                                         </button>
                                     ` : ''}
                                     
                                     ${project.result ? `
                                         <button class="btn btn-secondary" onclick="guessGame.showResults('${project.id}')">
                                             查看结果
                                         </button>
                                     ` : ''}
                                 </div>
                             </div>
                         `;
                     }).join('');
                     
                 } catch (error) {
                     console.error('渲染项目时发生错误:', error);
                 }
             }
             
             // 渲染我创建的项目
             async renderCreatedProjects() {
                 if (!this.currentUser) {
                     const container = document.getElementById('createdProjectsContainer');
                     if (container) {
                         container.innerHTML = '<div class="empty-state"><p>请先登录查看您的项目</p></div>';
                     }
                     return;
                 }
                 
                 const userProjects = this.projects.filter(p => p.creatorId === this.currentUser.uid);
                 const container = document.getElementById('createdProjectsContainer');
                 
                 if (!container) return;
                 
                 // 更新统计
                 this.updateMyProjectsStats();
                 
                 if (userProjects.length === 0) {
                     container.innerHTML = `
                         <div class="empty-state">
                             <p>您还没有创建任何项目</p>
                             <p>点击上方按钮创建您的第一个项目吧！</p>
                         </div>
                     `;
                     return;
                 }
                 
                 // 按状态排序，活跃项目在前
                 userProjects.sort((a, b) => {
                     if (a.status === 'active' && b.status !== 'active') return -1;
                     if (a.status !== 'active' && b.status === 'active') return 1;
                     return new Date(b.createTime) - new Date(a.createTime);
                 });
                 
                 container.innerHTML = userProjects.map(project => {
                     const projectVotes = this.votes.filter(v => v.projectId === project.id);
                     const totalVotes = projectVotes.length;
                     const totalPoints = projectVotes.reduce((sum, vote) => sum + vote.points, 0);
                     const timeLeft = this.getTimeLeft(project.deadline);
                     const isExpired = new Date(project.deadline) < new Date();
                     
                     return `
                         <div class="sub-card created-project">
                             <div class="project-header">
                                 <h4 class="project-title">${project.title}</h4>
                                 <span class="project-status ${project.status}">${project.status === 'active' ? '进行中' : project.status === 'completed' ? '已完成' : '已过期'}</span>
                             </div>
                             
                             <div class="project-meta">
                                 <span class="participant-count">👥 ${totalVotes} 人投票</span>
                                 <span class="points-count">💎 ${totalPoints} 积分</span>
                                 <span class="time-left">${timeLeft}</span>
                             </div>
                             
                             <p class="project-description">${project.description}</p>
                             
                             <div class="project-actions">
                                 ${!project.result && totalVotes > 0 ? `
                                     <button class="btn btn-success" onclick="guessGame.openPublishResultRequest('${project.id}')">
                                         发布结果
                                     </button>
                                 ` : ''}
                                 
                                 ${project.result ? `
                                     <button class="btn btn-secondary" onclick="guessGame.showResults('${project.id}')">
                                         查看结果
                                     </button>
                                 ` : ''}
                                 
                                 ${totalVotes === 0 && !project.result ? `
                                     <button class="btn btn-danger" onclick="guessGame.deleteProject('${project.id}')">
                                         删除项目
                                     </button>
                                 ` : ''}
                             </div>
                         </div>
                     `;
                 }).join('');
             }
             
             // 渲染我参与的项目
             async renderParticipatedProjects() {
                 if (!this.currentUser) {
                     const container = document.getElementById('participatedProjectsContainer');
                     if (container) {
                         container.innerHTML = '<div class="empty-state"><p>请先登录查看您参与的项目</p></div>';
                     }
                     return;
                 }
                 
                 const userVotes = this.votes.filter(v => v.userId === this.currentUser.uid);
                 const participatedProjects = userVotes.map(vote => {
                     const project = this.projects.find(p => p.id === vote.projectId);
                     return { ...project, userVote: vote };
                 }).filter(p => p.id); // 过滤掉已删除的项目
                 
                 const container = document.getElementById('participatedProjectsContainer');
                 if (!container) return;
                 
                 if (participatedProjects.length === 0) {
                     container.innerHTML = `
                         <div class="empty-state">
                             <p>您还没有参与任何项目</p>
                             <p>去投票页面参与一些有趣的项目吧！</p>
                         </div>
                     `;
                     return;
                 }
                 
                 container.innerHTML = participatedProjects.map(project => {
                     const timeLeft = this.getTimeLeft(project.deadline);
                     const isExpired = new Date(project.deadline) < new Date();
                     const selectedOption = project.options[project.userVote.selectedOption];
                     
                     return `
                         <div class="sub-card participated-project">
                             <div class="project-header">
                                 <h4 class="project-title">${project.title}</h4>
                                 <span class="project-status ${project.status}">${project.status === 'active' ? '进行中' : project.status === 'completed' ? '已完成' : '已过期'}</span>
                             </div>
                             
                             <div class="project-meta">
                                 <span class="vote-info">💎 投入 ${project.userVote.points} 积分</span>
                                 <span class="time-left">${timeLeft}</span>
                             </div>
                             
                             <p class="project-description">${project.description}</p>
                             
                             <div class="vote-details">
                                 <p><strong>我的选择：</strong>${selectedOption}</p>
                                 <p><strong>投票时间：</strong>${new Date(project.userVote.timestamp).toLocaleString()}</p>
                             </div>
                             
                             <div class="project-actions">
                                 ${!isExpired && project.status === 'active' ? `
                                     <button class="btn btn-primary" onclick="guessGame.openVoteModal('${project.id}')">
                                         重新投票
                                     </button>
                                 ` : ''}
                                 
                                 ${project.result ? `
                                     <button class="btn btn-secondary" onclick="guessGame.showResults('${project.id}')">
                                         查看结果
                                     </button>
                                 ` : ''}
                                 
                                 <button class="btn btn-danger" onclick="guessGame.deleteParticipatedProject('${project.id}')">
                                     删除记录
                                 </button>
                             </div>
                         </div>
                     `;
                 }).join('');
             }
             
             // 更新我的项目统计
             updateMyProjectsStats() {
                 if (!this.currentUser) return;
                 
                 const createdProjects = this.projects.filter(p => p.creatorId === this.currentUser.uid);
                 const participatedProjects = this.votes.filter(v => v.userId === this.currentUser.uid);
                 
                 const createdCount = createdProjects.length;
                 const participatedCount = participatedProjects.length;
                 const totalEarned = createdProjects.reduce((sum, project) => {
                     const projectVotes = this.votes.filter(v => v.projectId === project.id);
                     return sum + projectVotes.reduce((voteSum, vote) => voteSum + vote.points, 0);
                 }, 0);
                 
                 // 更新统计显示
                 const statsElements = {
                     created: document.querySelector('.created-count'),
                     participated: document.querySelector('.participated-count'),
                     earned: document.querySelector('.total-earned')
                 };
                 
                 if (statsElements.created) statsElements.created.textContent = createdCount;
                 if (statsElements.participated) statsElements.participated.textContent = participatedCount;
                 if (statsElements.earned) statsElements.earned.textContent = totalEarned;
             }
             
             // 计算剩余时间
             getTimeLeft(deadline) {
                 const now = new Date();
                 const end = new Date(deadline);
                 const diff = end - now;
                 
                 if (diff <= 0) {
                     return '已截止';
                 }
                 
                 const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                 const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                 const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                 
                 if (days > 0) {
                     return `${days}天${hours}小时`;
                 } else if (hours > 0) {
                     return `${hours}小时${minutes}分钟`;
                 } else {
                     return `${minutes}分钟`;
                 }
             }
             
             // 打开投票模态框
             openVoteModal(projectId) {
                 if (!this.currentUser) {
                     this.showCustomAlert('请先登录');
                     return;
                 }
                 
                 const project = this.projects.find(p => p.id === projectId);
                 if (!project) {
                     this.showCustomAlert('项目不存在');
                     return;
                 }
                 
                 // 检查项目状态
                 if (project.status !== 'active') {
                     this.showCustomAlert('项目已结束，无法投票');
                     return;
                 }
                 
                 // 检查是否过期
                 if (new Date(project.deadline) < new Date()) {
                     this.showCustomAlert('项目已过期，无法投票');
                     return;
                 }
                 
                 // 设置当前项目
                 this.selectedProjectId = projectId;
                 
                 // 填充模态框内容
                 document.getElementById('voteProjectTitle').textContent = project.title;
                 document.getElementById('voteProjectDescription').textContent = project.description;
                 
                 // 生成选项
                 const optionsContainer = document.getElementById('voteOptions');
                 optionsContainer.innerHTML = project.options.map((option, index) => `
                     <div class="vote-option">
                         <input type="radio" id="voteOption${index}" name="voteOption" value="${index}">
                         <label for="voteOption${index}">${option}</label>
                     </div>
                 `).join('');
                 
                 // 检查用户是否已投票
                 const existingVote = this.votes.find(v => v.projectId === projectId && v.userId === this.currentUser.uid);
                 if (existingVote) {
                     // 预选用户之前的选择
                     const previousOption = document.getElementById(`voteOption${existingVote.selectedOption}`);
                     if (previousOption) {
                         previousOption.checked = true;
                     }
                 }
                 
                 // 显示模态框
                 document.getElementById('voteModal').style.display = 'block';
             }
             
             // 提交投票
             async submitVote() {
                 const selectedOption = document.querySelector('input[name="voteOption"]:checked');
                 const pointsInput = document.getElementById('votePoints');
                 
                 if (!selectedOption) {
                     this.showCustomAlert('请选择一个选项');
                     return;
                 }
                 
                 const points = parseInt(pointsInput.value);
                 if (!points || points < 1) {
                     this.showCustomAlert('请输入有效的积分数量（至少1分）');
                     return;
                 }
                 
                 if (points > this.currentUser.points) {
                     this.showCustomAlert('积分不足');
                     return;
                 }
                 
                 const project = this.projects.find(p => p.id === this.selectedProjectId);
                 const optionIndex = parseInt(selectedOption.value);
                 const optionText = project.options[optionIndex];
                 
                 const confirmed = await this.showCustomConfirm(`确定要投票吗？\n\n项目：${project.title}\n选择：${optionText}\n积分：${points}`);
                 if (!confirmed) return;
                 
                 try {
                     // 尝试发送到后端
                     const voteData = {
                         projectId: this.selectedProjectId,
                         selectedOption: optionIndex,
                         points: points
                     };
                     
                     const apiUrl = `${this.apiConfig.baseURL}${this.apiConfig.endpoints.votes}`;
                     
                     try {
                         const response = await fetch(apiUrl, {
                             method: 'POST',
                             headers: {
                                 'Content-Type': 'application/json',
                                 'Authorization': `Bearer ${this.currentUser.accessToken}`
                             },
                             body: JSON.stringify(voteData)
                         });
                         
                         if (response.ok) {
                             const result = await response.json();
                             console.log('投票成功（后端）:', result);
                         } else {
                             throw new Error('后端投票失败');
                         }
                     } catch (error) {
                         console.log('后端投票失败，使用本地存储:', error.message);
                     }
                     
                     // 检查是否已有投票记录
                     const existingVoteIndex = this.votes.findIndex(v => v.projectId === this.selectedProjectId && v.userId === this.currentUser.uid);
                     
                     if (existingVoteIndex !== -1) {
                         // 更新现有投票
                         const oldVote = this.votes[existingVoteIndex];
                         const pointsDiff = points - oldVote.points;
                         
                         // 检查积分是否足够
                         if (pointsDiff > this.currentUser.points) {
                             this.showCustomAlert('积分不足以更新投票');
                             return;
                         }
                         
                         // 更新投票记录
                         this.votes[existingVoteIndex] = {
                             ...oldVote,
                             selectedOption: optionIndex,
                             points: points,
                             timestamp: new Date().toISOString()
                         };
                         
                         // 更新用户积分
                         this.currentUser.points -= pointsDiff;
                         
                         // 记录积分变化
                         if (pointsDiff !== 0) {
                             this.addPointsRecord(this.currentUser.uid, {
                                 type: 'vote',
                                 amount: -pointsDiff,
                                 description: `更新投票：${project.title}`,
                                 relatedId: this.selectedProjectId
                             });
                         }
                     } else {
                         // 创建新投票
                         const vote = {
                             id: Date.now().toString(),
                             projectId: this.selectedProjectId,
                             userId: this.currentUser.uid,
                             selectedOption: optionIndex,
                             points: points,
                             timestamp: new Date().toISOString()
                         };
                         
                         this.votes.push(vote);
                         
                         // 扣除用户积分
                         this.currentUser.points -= points;
                         
                         // 记录积分使用
                         this.addPointsRecord(this.currentUser.uid, {
                             type: 'vote',
                             amount: -points,
                             description: `投票：${project.title}`,
                             relatedId: this.selectedProjectId
                         });
                         
                         // 更新项目统计
                         const projectIndex = this.projects.findIndex(p => p.id === this.selectedProjectId);
                         if (projectIndex !== -1) {
                             this.projects[projectIndex].totalVotes = (this.projects[projectIndex].totalVotes || 0) + 1;
                             this.projects[projectIndex].totalPoints = (this.projects[projectIndex].totalPoints || 0) + points;
                         }
                     }
                     
                     // 保存数据
                     localStorage.setItem('votes', JSON.stringify(this.votes));
                     localStorage.setItem('projects', JSON.stringify(this.projects));
                     localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                     
                     // 更新用户数据
                     const users = JSON.parse(localStorage.getItem('users') || '{}');
                     users[this.currentUser.uid] = this.currentUser;
                     localStorage.setItem('users', JSON.stringify(users));
                     
                     // 更新显示
                     this.updateUserDisplay();
                     
                     // 关闭模态框
                     document.getElementById('voteModal').style.display = 'none';
                     
                     // 重新渲染项目
                     await this.renderProjects();
                     
                     this.showCustomAlert('投票成功！');
                     
                 } catch (error) {
                     console.error('投票时发生错误:', error);
                     this.showCustomAlert('投票失败，请重试');
                 }
             }
             
             // 显示项目结果
             showResults(projectId) {
                 const project = this.projects.find(p => p.id === projectId);
                 if (!project || !project.result) {
                     this.showCustomAlert('项目结果尚未发布');
                     return;
                 }
                 
                 const projectVotes = this.votes.filter(v => v.projectId === projectId);
                 const correctOption = project.result.correctOption;
                 const correctOptionText = project.options[correctOption];
                 
                 // 统计各选项投票情况
                 const optionStats = project.options.map((option, index) => {
                     const votes = projectVotes.filter(v => v.selectedOption === index);
                     const totalPoints = votes.reduce((sum, vote) => sum + vote.points, 0);
                     return {
                         option,
                         index,
                         votes: votes.length,
                         points: totalPoints,
                         isCorrect: index === correctOption
                     };
                 });
                 
                 // 用户的投票情况
                 const userVote = this.currentUser ? projectVotes.find(v => v.userId === this.currentUser.uid) : null;
                 
                 let resultContent = `
                     <div class="result-header">
                         <h3>${project.title}</h3>
                         <p class="correct-answer">正确答案：${correctOptionText}</p>
                     </div>
                     
                     <div class="result-stats">
                         <h4>投票统计：</h4>
                         ${optionStats.map(stat => `
                             <div class="option-stat ${stat.isCorrect ? 'correct' : ''}">
                                 <span class="option-text">${stat.option}</span>
                                 <span class="vote-count">${stat.votes} 票</span>
                                 <span class="points-count">${stat.points} 积分</span>
                                 ${stat.isCorrect ? '<span class="correct-mark">✓</span>' : ''}
                             </div>
                         `).join('')}
                     </div>
                 `;
                 
                 if (userVote) {
                     const userSelectedOption = project.options[userVote.selectedOption];
                     const isUserCorrect = userVote.selectedOption === correctOption;
                     
                     resultContent += `
                         <div class="user-result">
                             <h4>您的投票：</h4>
                             <p>选择：${userSelectedOption}</p>
                             <p>投入积分：${userVote.points}</p>
                             <p class="result-status ${isUserCorrect ? 'correct' : 'incorrect'}">
                                 ${isUserCorrect ? '恭喜您答对了！获得双倍奖励！' : '很遗憾，您答错了。'}
                             </p>
                         </div>
                     `;
                 }
                 
                 // 如果是创建者，显示收益信息
                 if (this.currentUser && project.creatorId === this.currentUser.uid) {
                     const incorrectVotes = projectVotes.filter(v => v.selectedOption !== correctOption);
                     const totalIncome = incorrectVotes.reduce((sum, vote) => sum + vote.points, 0);
                     
                     resultContent += `
                         <div class="creator-income">
                             <h4>创建者收益：</h4>
                             <p>总收入：${totalIncome} 积分</p>
                             <p>来源：错误投票的积分</p>
                         </div>
                     `;
                 }
                 
                 // 显示在自定义模态框中
                 this.showCustomAlert(resultContent, '项目结果');
             }
             
             // 显示自定义警告框
             showCustomAlert(message, title = '提示') {
                 const modal = document.getElementById('customAlert');
                 const titleElement = document.getElementById('alertTitle');
                 const messageElement = document.getElementById('alertMessage');
                 
                 titleElement.textContent = title;
                 messageElement.innerHTML = message;
                 modal.style.display = 'block';
             }
             
             // 隐藏自定义警告框
             hideCustomAlert() {
                 document.getElementById('customAlert').style.display = 'none';
             }
             
             // 显示自定义确认框
             showCustomConfirm(message, title = '确认') {
                 return new Promise((resolve) => {
                     const modal = document.getElementById('customConfirm');
                     const titleElement = document.getElementById('confirmTitle');
                     const messageElement = document.getElementById('confirmMessage');
                     
                     titleElement.textContent = title;
                     messageElement.textContent = message;
                     modal.style.display = 'block';
                     
                     // 设置按钮事件
                     const confirmBtn = document.getElementById('confirmYes');
                     const cancelBtn = document.getElementById('confirmNo');
                     
                     const handleConfirm = () => {
                         modal.style.display = 'none';
                         confirmBtn.removeEventListener('click', handleConfirm);
                         cancelBtn.removeEventListener('click', handleCancel);
                         resolve(true);
                     };
                     
                     const handleCancel = () => {
                         modal.style.display = 'none';
                         confirmBtn.removeEventListener('click', handleConfirm);
                         cancelBtn.removeEventListener('click', handleCancel);
                         resolve(false);
                     };
                     
                     confirmBtn.addEventListener('click', handleConfirm);
                     cancelBtn.addEventListener('click', handleCancel);
                 });
             }
             
             // 显示自定义输入框
             showCustomPrompt(message, defaultValue = '', title = '输入') {
                 return new Promise((resolve) => {
                     const modal = document.getElementById('customPrompt');
                     const titleElement = document.getElementById('promptTitle');
                     const messageElement = document.getElementById('promptMessage');
                     const inputElement = document.getElementById('promptInput');
                     
                     titleElement.textContent = title;
                     messageElement.textContent = message;
                     inputElement.value = defaultValue;
                     modal.style.display = 'block';
                     inputElement.focus();
                     
                     // 设置按钮事件
                     const confirmBtn = document.getElementById('promptOk');
                     const cancelBtn = document.getElementById('promptCancel');
                     
                     const handleConfirm = () => {
                         const value = inputElement.value.trim();
                         modal.style.display = 'none';
                         confirmBtn.removeEventListener('click', handleConfirm);
                         cancelBtn.removeEventListener('click', handleCancel);
                         inputElement.removeEventListener('keypress', handleKeypress);
                         resolve(value || null);
                     };
                     
                     const handleCancel = () => {
                         modal.style.display = 'none';
                         confirmBtn.removeEventListener('click', handleConfirm);
                         cancelBtn.removeEventListener('click', handleCancel);
                         inputElement.removeEventListener('keypress', handleKeypress);
                         resolve(null);
                     };
                     
                     const handleKeypress = (e) => {
                         if (e.key === 'Enter') {
                             handleConfirm();
                         } else if (e.key === 'Escape') {
                             handleCancel();
                         }
                     };
                     
                     confirmBtn.addEventListener('click', handleConfirm);
                     cancelBtn.addEventListener('click', handleCancel);
                     inputElement.addEventListener('keypress', handleKeypress);
                 });
             }
             
             // 删除单个投票记录
             async deleteSingleVote(voteId) {
                 if (!this.currentUser) {
                     this.showCustomAlert('请先登录');
                     return;
                 }
                 
                 const vote = this.votes.find(v => v.id === voteId);
                 if (!vote) {
                     this.showCustomAlert('投票记录不存在');
                     return;
                 }
                 
                 if (vote.userId !== this.currentUser.uid) {
                     this.showCustomAlert('只能删除自己的投票记录');
                     return;
                 }
                 
                 const project = this.projects.find(p => p.id === vote.projectId);
                 if (project && project.status !== 'active') {
                     this.showCustomAlert('项目已结束，无法删除投票记录');
                     return;
                 }
                 
                 const confirmed = await this.showCustomConfirm(`确定要删除这条投票记录吗？\n\n项目：${project?.title || '未知项目'}\n积分：${vote.points}`);
                 if (!confirmed) return;
                 
                 // 删除投票记录
                 this.votes = this.votes.filter(v => v.id !== voteId);
                 localStorage.setItem('votes', JSON.stringify(this.votes));
                 
                 // 退还积分
                 this.currentUser.points += vote.points;
                 localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                 
                 // 更新用户数据
                 const users = JSON.parse(localStorage.getItem('users') || '{}');
                 users[this.currentUser.uid] = this.currentUser;
                 localStorage.setItem('users', JSON.stringify(users));
                 
                 // 记录退款
                 this.addPointsRecord(this.currentUser.uid, {
                     type: 'refund',
                     amount: vote.points,
                     description: `删除投票退款：${project?.title || '未知项目'}`,
                     relatedId: vote.projectId
                 });
                 
                 // 更新显示
                 this.updateUserDisplay();
                 await this.renderProjects();
                 
                 this.showCustomAlert('投票记录已删除，积分已退还');
             }
             
             // 清空所有数据（测试用）
             async clearAllData() {
                 const confirmed = await this.showCustomConfirm('确定要清空所有数据吗？此操作不可恢复！', '危险操作');
                 if (!confirmed) return;
                 
                 const doubleConfirmed = await this.showCustomConfirm('再次确认：真的要删除所有项目、投票和用户数据吗？', '最终确认');
                 if (!doubleConfirmed) return;
                 
                 // 清空所有数据
                 localStorage.removeItem('projects');
                 localStorage.removeItem('votes');
                 localStorage.removeItem('users');
                 localStorage.removeItem('currentUser');
                 localStorage.removeItem('pendingResults');
                 localStorage.removeItem('withdrawalRequests');
                 localStorage.removeItem('pointsRecords');
                 
                 // 重置应用状态
                 this.projects = [];
                 this.votes = [];
                 this.currentUser = null;
                 this.pendingResults = [];
                 this.withdrawalRequests = [];
                 
                 // 更新显示
                 this.updateUserDisplay();
                 await this.renderProjects();
                 
                 this.showCustomAlert('所有数据已清空');
             }
             
             // 数据迁移（确保项目有正确的options结构）
             migrateData() {
                 try {
                     let needsSave = false;
                     
                     // 迁移项目数据
                     this.projects.forEach(project => {
                         if (!project.options || !Array.isArray(project.options)) {
                             project.options = ['选项1', '选项2']; // 默认选项
                             needsSave = true;
                         }
                         
                         if (!project.totalVotes) {
                             project.totalVotes = this.votes.filter(v => v.projectId === project.id).length;
                             needsSave = true;
                         }
                         
                         if (!project.totalPoints) {
                             const projectVotes = this.votes.filter(v => v.projectId === project.id);
                             project.totalPoints = projectVotes.reduce((sum, vote) => sum + vote.points, 0);
                             needsSave = true;
                         }
                     });
                     
                     if (needsSave) {
                         localStorage.setItem('projects', JSON.stringify(this.projects));
                         console.log('数据迁移完成');
                     }
                 } catch (error) {
                     console.error('数据迁移失败:', error);
                 }
             }
             
             // 改进的积分详情模态框（Android兼容）
             openPointsDetailModal() {
                 if (!this.currentUser) {
                     this.showCustomAlert('请先登录');
                     return;
                 }
                 
                 const modal = document.getElementById('pointsDetailModal');
                 
                 // Android设备优化
                 if (/Android/i.test(navigator.userAgent)) {
                     // 防止背景滚动
                     document.body.style.overflow = 'hidden';
                     
                     // 确保模态框在视口内
                     modal.style.position = 'fixed';
                     modal.style.top = '0';
                     modal.style.left = '0';
                     modal.style.width = '100%';
                     modal.style.height = '100%';
                 }
                 
                 modal.style.display = 'block';
                 
                 // 渲染积分详情
                 this.renderPointsDetailModal();
                 
                 // 添加动画效果
                 setTimeout(() => {
                     modal.classList.add('show');
                 }, 10);
             }
             
             // 关闭积分详情模态框（优化动画）
             closePointsDetailModal() {
                 const modal = document.getElementById('pointsDetailModal');
                 
                 // 添加关闭动画
                 modal.classList.remove('show');
                 
                 setTimeout(() => {
                     modal.style.display = 'none';
                     
                     // 恢复背景滚动（Android）
                     if (/Android/i.test(navigator.userAgent)) {
                         document.body.style.overflow = '';
                     }
                 }, 300);
             }
             
             // 添加积分记录
             addPointsRecord(userId, record) {
                 try {
                     const records = JSON.parse(localStorage.getItem('pointsRecords') || '{}');
                     
                     if (!records[userId]) {
                         records[userId] = [];
                     }
                     
                     const newRecord = {
                         id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                         timestamp: new Date().toISOString(),
                         ...record
                     };
                     
                     records[userId].push(newRecord);
                     
                     // 保持最近1000条记录
                     if (records[userId].length > 1000) {
                         records[userId] = records[userId].slice(-1000);
                     }
                     
                     localStorage.setItem('pointsRecords', JSON.stringify(records));
                 } catch (error) {
                     console.error('添加积分记录失败:', error);
                 }
             }
             
             // 渲染积分详情模态框
             renderPointsDetailModal() {
                 if (!this.currentUser) return;
                 
                 const records = JSON.parse(localStorage.getItem('pointsRecords') || '{}')[this.currentUser.uid] || [];
                 const sortedRecords = records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                 
                 // 计算总收入和支出
                 let totalIncome = 0;
                 let totalExpense = 0;
                 
                 sortedRecords.forEach(record => {
                     if (record.amount > 0) {
                         totalIncome += record.amount;
                     } else {
                         totalExpense += Math.abs(record.amount);
                     }
                 });
                 
                 // 计算余额
                 const calculatedBalance = totalIncome - totalExpense;
                 
                 // 验证余额一致性
                 const balanceConsistent = Math.abs(calculatedBalance - this.currentUser.points) < 0.01;
                 
                 // 更新摘要
                 document.getElementById('pointsSummary').innerHTML = `
                     <div class="summary-item">
                         <span class="label">当前余额：</span>
                         <span class="value ${balanceConsistent ? '' : 'error'}">${this.currentUser.points}</span>
                     </div>
                     <div class="summary-item">
                         <span class="label">总收入：</span>
                         <span class="value income">+${totalIncome}</span>
                     </div>
                     <div class="summary-item">
                         <span class="label">总支出：</span>
                         <span class="value expense">-${totalExpense}</span>
                     </div>
                     ${!balanceConsistent ? `
                         <div class="summary-item error">
                             <span class="label">计算余额：</span>
                             <span class="value">${calculatedBalance}</span>
                         </div>
                     ` : ''}
                 `;
                 
                 // 更新记录列表
                 const recordsList = document.getElementById('pointsRecordsList');
                 if (sortedRecords.length === 0) {
                     recordsList.innerHTML = '<div class="no-records">暂无积分记录</div>';
                 } else {
                     recordsList.innerHTML = sortedRecords.map(record => {
                         const date = new Date(record.timestamp);
                         const formattedDate = date.toLocaleString('zh-CN', {
                             year: 'numeric',
                             month: '2-digit',
                             day: '2-digit',
                             hour: '2-digit',
                             minute: '2-digit'
                         });
                         
                         const amountClass = record.amount > 0 ? 'income' : 'expense';
                         const amountText = record.amount > 0 ? `+${record.amount}` : record.amount;
                         
                         return `
                             <div class="record-item">
                                 <div class="record-header">
                                     <span class="record-type">${this.getPointTypeDescription(record.type)}</span>
                                     <span class="record-amount ${amountClass}">${amountText}</span>
                                 </div>
                                 <div class="record-description">${record.description}</div>
                                 <div class="record-time">${formattedDate}</div>
                             </div>
                         `;
                     }).join('');
                 }
             }
             
             // 获取积分类型描述
             getPointTypeDescription(type) {
                 const descriptions = {
                     'recharge': '充值',
                     'withdraw': '提现',
                     'vote': '投票',
                     'reward': '奖励',
                     'penalty': '惩罚',
                     'refund': '退款',
                     'income': '收入'
                 };
                 return descriptions[type] || type;
             }
         }
         
         // 初始化应用
         let gameApp;
         
         // 移动端优化的DOM加载
         if (document.readyState === 'loading') {
             document.addEventListener('DOMContentLoaded', initApp);
         } else {
             // DOM已经加载完成
             setTimeout(initApp, 0);
         }
         
         function initApp() {
             try {
                 gameApp = new GuessGamePlatform();
                 
                 // 绑定键盘快捷键
                 document.addEventListener('keydown', (e) => {
                     // Ctrl+Shift+C 清空数据（开发用）
                     if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                         e.preventDefault();
                         gameApp.clearAllData();
                     }
                 });
                 
                 // 定期检查过期项目
                 setInterval(() => {
                     if (gameApp) {
                         gameApp.handleTimedOutProjects();
                     }
                 }, 60000); // 每分钟检查一次
                 
                 // 定期刷新数据
                 setInterval(() => {
                     if (gameApp && gameApp.currentUser) {
                         gameApp.renderProjects();
                     }
                 }, 300000); // 每5分钟刷新一次
                 
                 console.log('应用初始化完成');
             } catch (error) {
                 console.error('应用初始化失败:', error);
             }
         }
         
         // UI辅助函数
         function toggleCard(cardId) {
             const card = document.getElementById(cardId);
             if (card) {
                 card.classList.toggle('collapsed');
             }
         }
         
         function toggleSubCard(element) {
             const subCard = element.closest('.sub-card');
             if (subCard) {
                 subCard.classList.toggle('collapsed');
             }
         }
     </script>
 </body>
 </html>